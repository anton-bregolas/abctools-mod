var angloFingeringsGenerator=function(e,a){var r,n=!1,t="",s=function(e,a,r,n){this.name=e,this.notes=a,this.cost=r,this.finger=n},c=0,l=1,i={L1a:new s("L1a",["E,","F,"],10,"l4"),L2a:new s("L2a",["A,","_B,"],10,"l4"),L3a:new s("L3a",["^C","_E"],10,"l3"),L4a:new s("L4a",["A","G"],10,"l2"),L5a:new s("L5a",["^G","_B"],10,"l1"),L1:new s("L1",["C,","G,"],1,"l4"),L2:new s("L2",["G,","B,"],1,"l4"),L3:new s("L3",["C","D"],1,"l3"),L4:new s("L4",["E","F"],1,"l2"),L5:new s("L5",["G","A"],1,"l1"),L6:new s("L6",["B,","A,"],1,"l4"),L7:new s("L7",["D","^F"],2,"l4"),L8:new s("L8",["G","A"],2,"l3"),L9:new s("L9",["B","c"],2,"l2"),L10:new s("L10",["d","e"],2,"l1"),R1:new s("R1",["c","B"],1,"r1"),R2:new s("R2",["e","d"],1,"r2"),R3:new s("R3",["g","f"],2,"r3"),R4:new s("R4",["c'","a"],2,"r4"),R5:new s("R5",["e'","b"],2,"r4"),R6:new s("R6",["g","^f"],1,"r1"),R7:new s("R7",["b","a"],1,"r2"),R8:new s("R8",["d'","c'"],1,"r3"),R9:new s("R9",["g'","e'"],1,"r4"),R10:new s("R10",["b'","^f'"],1,"r4")};new s("L1a",["E,","F,"],10,"l4"),new s("L2a",["A,","_B,"],10,"l4"),new s("L3a",["^C","_E"],10,"l3"),new s("L4a",["A","G"],10,"l2"),new s("L5a",["^G","_B"],10,"l1"),new s("L1",["C,","G,"],1,"l4"),new s("L2",["G,","B,"],1,"l4"),new s("L3",["C","D"],1,"l3"),new s("L4",["E","F"],1,"l2"),new s("L5",["G","A"],1,"l1"),new s("L6",["B,","A,"],1,"l4"),new s("L7",["D","^F"],2,"l4"),new s("L8",["G","A"],2,"l3"),new s("L9",["B","c"],2,"l2"),new s("L10",["d","e"],1,"l1"),new s("R1",["c","B"],1,"r1"),new s("R2",["e","d"],2,"r2"),new s("R3",["g","f"],2,"r3"),new s("R4",["c'","a"],2,"r4"),new s("R5",["e'","b"],2,"r4"),new s("R6",["g","^f"],1,"r1"),new s("R7",["b","a"],1,"r2"),new s("R8",["d'","c'"],1,"r3"),new s("R9",["g'","e'"],1,"r4"),new s("R10",["b'","^f'"],1,"r4");var o={L1a:new s("L1a",["E,","F,"],10,"l4"),L2a:new s("L2a",["A,","_B,"],10,"l4"),L3a:new s("L3a",["^C","_E"],10,"l3"),L4a:new s("L4a",["A","G"],10,"l2"),L5a:new s("L5a",["^G","_B"],10,"l1"),L1:new s("L1",["C,","G,"],1,"l4"),L2:new s("L2",["G,","B,"],1,"l4"),L3:new s("L3",["C","D"],1,"l3"),L4:new s("L4",["E","F"],1,"l2"),L5:new s("L5",["G","A"],1,"l1"),L6:new s("L6",["B,","A,"],1,"l4"),L7:new s("L7",["D","^F"],2,"l4"),L8:new s("L8",["G","A"],2,"l3"),L9:new s("L9",["B","z"],2,"l2"),L9a:new s("L9",["z","c"],1,"l2"),L10:new s("L10",["d","e"],1,"l1"),R1:new s("R1",["c","x"],2,"r1"),R1x:new s("R1",["x","B"],1,"r1"),R2:new s("R2",["e","d"],2,"r2"),R3:new s("R3",["g","f"],2,"r3"),R4:new s("R4",["c'","a"],2,"r4"),R5:new s("R5",["e'","b"],2,"r4"),R6:new s("R6",["g","^f"],1,"r1"),R7:new s("R7",["b","a"],1,"r2"),R8:new s("R8",["d'","c'"],1,"r3"),R9:new s("R9",["g'","e'"],1,"r4"),R10:new s("R10",["b'","^f'"],1,"r4")};new s("R1a",["^d","^c"],1,"r1"),new s("R2a",["^c","^d"],10,"r2"),new s("R3a",["^g","g"],10,"r3"),new s("R4a",["^c'","_b"],10,"r4"),new s("R5a",["a","d'"],10,"r4");var _={R1a:new s("R1a",["^d","^c"],10,"r1"),R2a:new s("R2a",["^c","^d"],1,"r2"),R3a:new s("R3a",["^g","g"],10,"r3"),R4a:new s("R4a",["^c'","_b"],10,"r4"),R5a:new s("R5a",["a","d'"],10,"r4")},u={R1a:new s("R1a",["^c","^d"],10,"r1"),R2a:new s("R2a",["a","g"],10,"r2"),R3a:new s("R3a",["^g","_b"],10,"r3"),R4a:new s("R4a",["^c'","_e'"],10,"r4"),R5a:new s("R5a",["a","f'"],10,"r4")},d=["1a","2a","3a","4a","5a","1a","2a","3a","4a","5a","1","2","3","4","5","1","2","3","4","5","6","7","8","9","10","6","7","8","9","10"],f=null,g=null,h=null;function $(e){var a=gAngloButtonNames;return gInjectTab_GaryCoover&&(gAngloButtonNames=d),e.L1a.name=gAngloButtonNames[0],e.L2a.name=gAngloButtonNames[1],e.L3a.name=gAngloButtonNames[2],e.L4a.name=gAngloButtonNames[3],e.L5a.name=gAngloButtonNames[4],e.R1a.name=gAngloButtonNames[5],e.R2a.name=gAngloButtonNames[6],e.R3a.name=gAngloButtonNames[7],e.R4a.name=gAngloButtonNames[8],e.R5a.name=gAngloButtonNames[9],e.L1.name=gAngloButtonNames[10],e.L2.name=gAngloButtonNames[11],e.L3.name=gAngloButtonNames[12],e.L4.name=gAngloButtonNames[13],e.L5.name=gAngloButtonNames[14],e.R1.name=gAngloButtonNames[15],e.R1x&&(e.R1x.name=gAngloButtonNames[15]),e.R2.name=gAngloButtonNames[16],e.R3.name=gAngloButtonNames[17],e.R4.name=gAngloButtonNames[18],e.R5.name=gAngloButtonNames[19],e.L6.name=gAngloButtonNames[20],e.L7.name=gAngloButtonNames[21],e.L8.name=gAngloButtonNames[22],e.L9.name=gAngloButtonNames[23],e.L9a&&(e.L9a.name=gAngloButtonNames[23]),e.L10.name=gAngloButtonNames[24],e.R6.name=gAngloButtonNames[25],e.R7.name=gAngloButtonNames[26],e.R8.name=gAngloButtonNames[27],e.R9.name=gAngloButtonNames[28],e.R10.name=gAngloButtonNames[29],gInjectTab_GaryCoover&&(gAngloButtonNames=a),e}function p(){var e=parseInt(gInjectTab_ConcertinaFingering);switch(f=[],g=[],e){case 0:for(var a in _)f[a]=_[a];for(var a in u)g[a]=u[a];for(var a in i)f[a]=i[a],g[a]=i[a];break;case 1:for(var a in _)f[a]=_[a];for(var a in u)g[a]=u[a];for(var a in o)f[a]=o[a];for(var a in o)g[a]=o[a]}h=0==parseInt(gInjectTab_ConcertinaStyle)?f:g,h=$(h)}var m=null,G=null,v=0;function A(e){n&&console.log(e)}function F(e){if(A("Got input:"+e),p(),null==(m=C(e)))return"ERROR: Unknown or unsupported key signature";var a=S(e),r=O(h);X(r);var n=L(a,r),s=N(n);return null==s?(A("No fingerings generated!"),t):t=y(e,s,a)}var x=function(e,a){this.states=e,this.cost=a},D=function(e,a,r){this.index=e,this.unNormalizedValue=a,this.normalizedValue=r},E=function(e,a,r){this.note=e,this.button=a,this.direction=r,this.nextStates=[],this.id=v++,this.toString=function(){var e="["+this.id+"] Note:";return this.note?e+=this.note.normalizedValue:e+="none",e+=" Button:"+this.button.name}};function C(e){var a,r,n=null,t=e.match(/^K: *([A-G])([b#])? *(.*?)$/m);if(null==t||t.length<3)return null;a=void 0==t[2]?t[1]:t[1]+t[2];var s=/%.*/;if(A("Got base key of '"+a+"' and extra of '"+(r=(r=(r=t[3].toLowerCase()).replace(s,"")).trim())+"'"),""==r||-1!=r.search("maj")||-1!=r.search("ion")?(A("Mode: Ionian (major)"),n=B(a,0)):-1!=r.search("mix")?(A("Mode: Mixolydian"),n=B(a,1)):-1!=r.search("dor")?(A("Mode: Dorian"),n=B(a,2)):-1!=r.search("m")&&-1==r.search("mix")||-1!=r.search("min")||-1!=r.search("aeo")?(A("Mode: Aeolian (minor)"),n=B(a,3)):-1!=r.search("phr")?(A("Mode: Phrygian"),n=B(a,4)):-1!=r.search("loc")?(A("Mode: Locrian"),n=B(a,5)):-1!=r.search("lyd")?(A("Mode: Lydian"),n=B(a,-1)):-1!=r.search("exp")?(A("(Accidentals to be explicitly specified)"),n=B("C",0)):(A("Failed to determine key signature mode"),n=null),null==n)return n;var c=r.match(/_./g),l=r.match(/\^./g);for(note in c)n.flats+=c[note][1].toUpperCase();for(note in l)n.sharps+=l[note][1].toUpperCase();return n}function B(e,a){var r="FCGDAEB",n={sharps:"",flats:""},t=r.indexOf(e[0])-1;if(-2==t)return A("Bad tonic: "+e),null;"b"==e.slice(1)?t-=7:"#"==e.slice(1)&&(t+=7);var s=t-a;return s>7?(A("Too many sharps: "+s),null):s<-7?(A("Too many flats: "+-1*s),null):(s>0?n.sharps=r.slice(0,s):s<0&&(n.flats=r.slice(s)),n.accidentalSharps="",n.accidentalFlats="",n.accidentalNaturals="",n)}function y(e,a,r){if(a.states.shift(),a.states.length!=r.length)return"ERROR: Internal error. Length mismatch";for(var n=e,t=0,s=parseInt(gInjectTab_TabLocation),c=0;c<a.states.length;++c){var l=r[c].index+t,i=a.states[c].button.name;if(gInjectTab_GaryCoover){if(0==a.states[c].button.finger.indexOf("l")){if(a.states[c].direction==P)i='"_ ;'+i+'"';else{for(var o=i.length,_="",u=0;u<o;++u)_+="_";var d=i;i=(i='"_'+_+";")+d+'"'}}else if(a.states[c].direction==P)i='"^'+i+'"';else{for(var o=i.length,_="",u=0;u<o;++u)_+="_";var d=i;i=(i='"^'+_+";")+d+'"'}}else if(gInjectTab_UseBarForDraw)switch(s){case 0:if(a.states[c].direction==P)i='"^'+i+'"';else{for(var o=i.length,_="",u=0;u<o;++u)_+="_";var d=i;i=(i='"^'+_+";")+d+'"'}break;case 1:if(a.states[c].direction==P)i='"_ ;'+i+'"';else{for(var o=i.length,_="",u=0;u<o;++u)_+="_";var d=i;i=(i='"_'+_+";")+d+'"'}}else switch(s){case 0:i=(i='"^'+i+";")+a.states[c].direction+'"';break;case 1:i=(i='"_'+i+";")+a.states[c].direction+'"'}var f=i.length;n=n.substr(0,l)+i+n.substr(l),t+=f}return n}function w(e,a){if(e.normalizedValue==a.notes[c])return P;if(e.normalizedValue==a.notes[l])return I;var r=U(e.normalizedValue);return r==a.notes[c]?P:r==a.notes[l]?I:" "}function R(e,a){return e.finger==a.finger&&e.name!=a.name}function L(e,a){for(var r=null,n=null,c=0;c<e.length;++c){var l=e[c],i=l.normalizedValue,o=a[i];if(null==o||o.length<1){A("Failed to find button for note "+i),A("Attempting respell...");var _=z(i);if(A("Respelled as "+_),null==(o=a[_])||o.length<1)return A("Respelling as "+_+" failed to find a button."),t="ERROR:Failed to find button for note '"+i+"'",null}var u=[];o.forEach(function(e){u.push(new E(l,e,w(l,e)))}),null==r&&(r=u),null!=n&&n.forEach(function(e){e.nextStates=u}),n=u}var d=new E(null,new s("root",[],0,"none"));return d.nextStates=r,d}function N(e){return r=1e8,G={},k(e)}function k(e){if(0==e.nextStates.length)return A("Last state, note="+e.note.normalizedValue+" button="+e.button.name+". Popping up the stack"),new x([e],e.button.cost);var a=e.note,r=null,n=null;if(null!=a&&(r=a.unNormalizedValue,n=a.normalizedValue),A("Choosing: current note="+n+" button="+e.button.name),G[e])return A("Already visited state note="+e.note.normalizedValue+" button="+e.button.name),G[e];for(var t=new x([],1e7),s=0;s<e.nextStates.length;++s){var c=e.nextStates[s];A("Trying next ["+s+"/"+e.nextStates.length+"] note="+c.note.normalizedValue+" button="+c.button.name);var l=k(c);if(null==l)return A("Could not get fingerings"),null;var i=e.button.cost,o=100;if(0!=l.states.length){var _=l.states[0].button;l.states[0].button.finger,R(e.button,_)&&(A("Penalizing finger hop for note "+n),i+=o)}if(A("path had cost of "+l.cost+" my cost="+i),l.cost+i<t.cost){var u=l.states.slice(0);u.unshift(e),A("New best path for note["+n+"], cost="+(t=new x(u,l.cost+i)).cost)}}return G[e]=t,A("Done choosing: current note="+n+" button="+e.button.name+" best cost="+t.cost),t}function M(e,a,r){for(var n="",t=0;t<r;++t)n+="*";return e.substr(0,a)+n+e.substr(a+r)}function S(e){for(var a,r,n=e,t=/^\w:.*$/mg;a=t.exec(e);)n=M(n,a.index,a[0].length);for(var s=/"[^"]*"/gm;r=s.exec(n);)for(var c=r.index,l=c+r[0].length,i=c;i<l;++i)n=n.substring(0,i)+"*"+n.substring(i+1);for(s=/\[[^\]|]*\]/g;r=s.exec(n);)for(var c=r.index,l=c+r[0].length,i=c;i<l;++i)n=n.substring(0,i)+"*"+n.substring(i+1);for(s=/![^!\n]*!/gm;r=s.exec(n);)for(var c=r.index,l=c+r[0].length,i=c;i<l;++i)n=n.substring(0,i)+"*"+n.substring(i+1);for(s=/^%%begintext((.|\n)*)%%endtext/gm;r=s.exec(n);)for(var c=r.index,l=c+r[0].length,i=c;i<l;++i)n=n.substring(0,i)+"*"+n.substring(i+1);for(s=/^%.*$/gm;r=s.exec(n);)for(var c=r.index,l=c+r[0].length,i=c;i<l;++i)n=n.substring(0,i)+"*"+n.substring(i+1);n=n.replaceAll("!","*"),A("orginal input:\n"+e),A("sanitized input:\n"+n);for(var o=/([=^_]?[a-gA-G][',]?|\|)/g,_=[];r=o.exec(n);){var u=r[1];if("|"==u)m.accidentalFlats="",m.accidentalSharps="",m.accidentalNaturals="";else{var d=j(u);A("UnNormalized="+u+" normalized="+d),_.push(new D(r.index,u,d))}}return _}function z(e){var a=e,r={_B:"^A","^B":"C",_C:"B",_D:"^C","^D":"_E",_E:"^D","^E":"F",_F:"E",_G:"^F","^G":"_A"};for(var n in r)a=(a=a.replace(n,r[n])).replace(n.toLowerCase(),r[n].toLowerCase());return a}function U(e){var a=e,r={"^A":"_B","^D":"_E","^G":"_A"};for(var n in r)a=(a=a.replace(n,r[n])).replace(n.toLowerCase(),r[n].toLowerCase());return a}function j(e){var a=e.search(/[A-G]/i);if(-1==a)return A("Failed to find basename for value!"),e;var r=e.substr(a,1).toUpperCase();return"="==e.substr(0,1)?(m.accidentalFlats=m.accidentalFlats.replace(r,""),m.accidentalSharps=m.accidentalSharps.replace(r,""),m.accidentalNaturals+=r,e.substr(1)):"_"==e.substr(0,1)?(m.accidentalFlats+=r,m.accidentalSharps=m.accidentalSharps.replace(r,""),m.accidentalNaturals=m.accidentalNaturals.replace(r,""),e):"^"==e.substr(0,1)?(m.accidentalFlats=m.accidentalFlats.replace(r,""),m.accidentalNaturals=m.accidentalNaturals.replace(r,""),m.accidentalSharps+=r,e):-1!=m.accidentalNaturals.search(r)?e:-1!=m.sharps.search(r)||-1!=m.accidentalSharps.search(r)?"^"+e:-1!=m.flats.search(r)||-1!=m.accidentalFlats.search(r)?"_"+e:e}function X(e){for(var a in e)e[a].sort(function(e,a){return e.cost-a.cost})}function O(e){var a={};for(var r in e){var n=e[r].notes;if(null==n){A("Failed to find entry for button "+b);continue}n.forEach(function(n){null==a[n]?a[n]=[e[r]]:a[n].push(e[r]),null==a[n=z(n)]?a[n]=[e[r]]:a[n].push(e[r])})}return a}function V(e){return e.split(/^X:.*$/gm).length-1}function T(e,a){return"X:"+e.split(/^X:/gm)[a+1]}var P="↓",I="↑";function K(e,a){var r=e.split(/^X:.*$/gm).length-1,n=gInjectTab_FontFamily,t=gInjectTab_TabFontSize,s=gInjectTab_MusicSpace,c=gInjectTab_StaffSep,l=parseInt(gInjectTab_TabLocation),i=gInjectTab_StripChords;P=gInjectTab_PushGlyph,I=gInjectTab_DrawGlyph;for(var o=FindPreTuneHeader(e),_=!1,u=[],d=parseInt(gInjectTab_TabLocation),f=0;f<r;++f){var g=T(e,f),h=g;if(isSectionHeader(g)||isMultiVoiceTune(g)){o+=g;continue}g=StripTabOne(g),(gInjectTab_GaryCoover||0==l||1==l&&i)&&(g=StripChordsOne(g));try{g=F(g)}catch($){o+=h;var p=getTuneTitle(h);u.push(p),_=!0;continue}g=InjectStringBelowTuneHeaderConditional(g,"%%staffsep "+c),g=InjectStringAboveTuneHeaderConditional(g,"%%annotationfont "+n+" "+t),(0==d||gInjectTab_GaryCoover)&&(g=InjectStringAboveTuneHeaderConditional(g,"%%musicspace "+s)),o+=g}if(_){for(var m='<p style="text-align:center;font-size:18px;margin-bottom:18px">No Anglo Concertina tablature generated for one or more tunes:</p>',G=0;G<u.length;++G)m+='<p style="text-align:center;font-size:18px;">'+u[G]+"</p>";a(o,!0,m+='<p style="text-align:center;font-size:18px;line-height:24px;margin-top:18px">Some notes may be outside the range or not available on the selected style of Anglo concertina.</p>')}else a(o,!1,"")}return K(e,a)},boxTabGenerator=function(e){var a=!1,r=null;function n(e){a&&console.log(e)}function t(e){n("Got input:"+e);var a=parseInt(gInjectTab_BoxStyle);if(null==(r=c(e)))return"ERROR: Unknown or unsupported key signature";var t=u(e,a);return i(e,t)}var s=function(e,a,r,n){this.index=e,this.unNormalizedValue=a,this.normalizedValue=r,this.glyph=n};function c(e){var a,r,t=null,s=e.match(/^K: *([A-G])([b#])? *(.*?)$/m);if(null==s||s.length<3)return null;a=void 0==s[2]?s[1]:s[1]+s[2];var c=/%.*/;if(n("Got base key of '"+a+"' and extra of '"+(r=(r=(r=s[3].toLowerCase()).replace(c,"")).trim())+"'"),""==r||-1!=r.search("maj")||-1!=r.search("ion")?(n("Mode: Ionian (major)"),t=l(a,0)):-1!=r.search("mix")?(n("Mode: Mixolydian"),t=l(a,1)):-1!=r.search("dor")?(n("Mode: Dorian"),t=l(a,2)):-1!=r.search("m")&&-1==r.search("mix")||-1!=r.search("min")||-1!=r.search("aeo")?(n("Mode: Aeolian (minor)"),t=l(a,3)):-1!=r.search("phr")?(n("Mode: Phrygian"),t=l(a,4)):-1!=r.search("loc")?(n("Mode: Locrian"),t=l(a,5)):-1!=r.search("lyd")?(n("Mode: Lydian"),t=l(a,-1)):-1!=r.search("exp")?(n("(Accidentals to be explicitly specified)"),t=l("C",0)):(n("Failed to determine key signature mode"),t=null),null==t)return t;var i=r.match(/_./g),o=r.match(/\^./g);for(note in i)t.flats+=i[note][1].toUpperCase();for(note in o)t.sharps+=o[note][1].toUpperCase();return t}function l(e,a){var r="FCGDAEB",t={sharps:"",flats:""},s=r.indexOf(e[0])-1;if(-2==s)return n("Bad tonic: "+e),null;"b"==e.slice(1)?s-=7:"#"==e.slice(1)&&(s+=7);var c=s-a;return c>7?(n("Too many sharps: "+c),null):c<-7?(n("Too many flats: "+-1*c),null):(c>0?t.sharps=r.slice(0,c):c<0&&(t.flats=r.slice(c)),t.accidentalSharps="",t.accidentalFlats="",t.accidentalNaturals="",t)}function i(e,a){for(var r,n=e,t=0,s=parseInt(gInjectTab_TabLocation),c=0;c<a.length;++c){var l=a[c].index+t,i=a[c].glyph,o=i.length,_=i.substr(0,1),u=i.substr(1,o-1);if(0==i.indexOf("10")&&(_=i.substr(0,2),u=i.substr(2,o-1)),1==gInjectTab_BoxTabStyle){switch(_){case"①":_="1'";break;case"②":_="2'";break;case"③":_="3'";break;case"④":_="4'";break;case"⑤":_="5'";break;case"⑥":_="6'";break;case"⑦":_="7'";break;case"⑧":_="8'";break;case"⑨":_="9'";break;case"⑩":_="10'";break;case"⑪":_="11'"}r=u==h?'"_'+_+';-; "':'"_ ;-;'+_+'"'}else if(gInjectTab_UseBarForDraw)switch(s){case 0:if(u==h)r='"^'+_+'"';else{for(var d=_.length,f="",g=0;g<d;++g)f+="_";if(gIsChrome||gIsSafari)switch(_){case"①":case"②":case"③":case"④":case"⑤":case"⑥":case"⑦":case"⑧":case"⑨":case"⑩":case"⑪":f+="_"}r=(r='"^'+f+";")+_+'"'}break;case 1:if(u==h)r='"_ ;'+_+'"';else{for(var d=_.length,f="",g=0;g<d;++g)f+="_";if(gIsChrome||gIsSafari)switch(_){case"①":case"②":case"③":case"④":case"⑤":case"⑥":case"⑦":case"⑧":case"⑨":case"⑩":case"⑪":f+="_"}r=(r='"_'+f+";")+_+'"'}}else switch(s){case 0:r=(r='"^'+_+";")+u+'"';break;case 1:r=(r='"_'+_+";")+u+'"'}var $=r.length;n=n.substr(0,l)+r+n.substr(l),t+=$}return n}function o(e,a,r){for(var n="",t=0;t<r;++t)n+="*";return e.substr(0,a)+n+e.substr(a+r)}function _(e,a){switch(a){case 0:var r={"^D,":"①"+h,"_E,":"①"+h,"E,":"1"+h,"F,":"x ","^F,":"②"+h,"_G,":"②"+h,"G,":"2"+h,"^G,":"①"+$,"_A,":"①"+$,"A,":"1"+$,"^A,":"②"+$,"_B,":"②"+$,"B,":"2"+$,C:"3"+h,"^C":"③"+$,_D:"③"+$,D:"3"+$,"^D":"④"+h,_E:"④"+h,E:"4"+h,F:"4"+$,"^F":"⑤"+h,_G:"⑤"+h,G:"5"+h,"^G":"⑤"+$,_A:"⑤"+$,A:"5"+$,"^A":"⑥"+$,_B:"⑥"+$,B:"6"+$,c:"6"+h,"^c":"⑦"+$,_d:"⑦"+$,d:"7"+$,"^d":"⑦"+h,_e:"⑦"+h,e:"7"+h,f:"8"+$,"^f":"⑧"+h,_g:"⑧"+h,g:"8"+h,"^g":"⑨"+$,_a:"⑨"+$,a:"9"+$,"^a":"⑩"+$,_b:"⑩"+$,b:"10"+$,"c'":"9"+h,"^c'":"⑪"+$,"_d'":"⑪"+$,"d'":"x ","^d'":"⑩"+h,"_e'":"⑩"+h,"e'":"10"+h,"^f'":"⑪"+h,"_g'":"⑪"+h},n=r[e];if(!n)return"x ";break;case 1:var r={"F,":"①"+h,"^F,":"1"+h,"_G,":"1"+h,"G,":"x ","^G,":"②"+h,"_A,":"②"+h,"A,":"2"+h,"^A,":"①"+$,"_B,":"①"+$,"B,":"1"+$,C:"②"+$,"^C":"2"+$,_D:"2"+$,D:"3"+h,"^D":"③"+$,_E:"③"+$,E:"3"+$,F:"④"+h,"^F":"4"+h,_G:"4"+h,G:"4"+$,"^G":"⑤"+h,_A:"⑤"+h,A:"5"+h,"^A":"⑤"+$,_B:"⑤"+$,B:"5"+$,c:"⑥"+$,"^c":"6"+$,_d:"6"+$,d:"6"+h,"^d":"⑦"+$,_e:"⑦"+$,e:"7"+$,f:"⑦"+h,"^f":"7"+h,_g:"7"+h,g:"8"+$,"^g":"⑧"+h,_a:"⑧"+h,a:"8"+h,"^a":"⑨"+$,_b:"⑨"+$,b:"9"+$,"c'":"⑩"+$,"^c'":"10"+$,"_d'":"10"+$,"d'":"9"+h,"^d'":"⑪"+$,"_e'":"⑪"+$,"e'":"x ","f'":"⑩"+h,"^f'":"10"+h,"_g'":"10"+h,"g'":"x ","^g'":"⑪"+h,"_a'":"⑪"+h},n=r[e];if(!n)return"x "}return n}function u(e,a){for(var t,c,l=e,i=/^\w:.*$/mg;t=i.exec(e);)l=o(l,t.index,t[0].length);for(var u=/"[^"]*"/gm;c=u.exec(l);)for(var f=c.index,g=f+c[0].length,h=f;h<g;++h)l=l.substring(0,h)+"*"+l.substring(h+1);for(u=/\[[^\]|]*\]/g;c=u.exec(l);)for(var f=c.index,g=f+c[0].length,h=f;h<g;++h)l=l.substring(0,h)+"*"+l.substring(h+1);for(u=/![^!\n]*!/gm;c=u.exec(l);)for(var f=c.index,g=f+c[0].length,h=f;h<g;++h)l=l.substring(0,h)+"*"+l.substring(h+1);for(u=/^%%begintext((.|\n)*)%%endtext/gm;c=u.exec(l);)for(var f=c.index,g=f+c[0].length,h=f;h<g;++h)l=l.substring(0,h)+"*"+l.substring(h+1);for(u=/^%.*$/gm;c=u.exec(l);)for(var f=c.index,g=f+c[0].length,h=f;h<g;++h)l=l.substring(0,h)+"*"+l.substring(h+1);n("sanitized input:"+(l=l.replaceAll("!","*")));for(var $=/([=^_]?[a-gA-G][',]?|\|)/g,p=[];c=$.exec(l);){var m=c[1];if("|"==m)r.accidentalFlats="",r.accidentalSharps="",r.accidentalNaturals="";else{var G=d(m);n("UnNormalized="+m+" normalized="+G);var v=_(G,a);p.push(new s(c.index,m,G,v))}}return p}function d(e){var a=e.search(/[A-G]/i);if(-1==a)return n("Failed to find basename for value!"),e;var t=e.substr(a,1).toUpperCase();return"="==e.substr(0,1)?(r.accidentalFlats=r.accidentalFlats.replace(t,""),r.accidentalSharps=r.accidentalSharps.replace(t,""),r.accidentalNaturals+=t,e.substr(1)):"_"==e.substr(0,1)?(r.accidentalFlats+=t,r.accidentalSharps=r.accidentalSharps.replace(t,""),r.accidentalNaturals=r.accidentalNaturals.replace(t,""),e):"^"==e.substr(0,1)?(r.accidentalFlats=r.accidentalFlats.replace(t,""),r.accidentalNaturals=r.accidentalNaturals.replace(t,""),r.accidentalSharps+=t,e):-1!=r.accidentalNaturals.search(t)?e:-1!=r.sharps.search(t)||-1!=r.accidentalSharps.search(t)?"^"+e:-1!=r.flats.search(t)||-1!=r.accidentalFlats.search(t)?"_"+e:e}function f(e){return e.split(/^X:.*$/gm).length-1}function g(e,a){return"X:"+e.split(/^X:/gm)[a+1]}var h="↓",$="↑";function p(e){var a=e.split(/^X:.*$/gm).length-1,r=gInjectTab_FontFamily,n=gInjectTab_TabFontSize,s=gInjectTab_MusicSpace,c=gInjectTab_StaffSep,l=parseInt(gInjectTab_TabLocation),i=gInjectTab_StripChords;h=gInjectTab_PushGlyph,$=gInjectTab_DrawGlyph;for(var o=FindPreTuneHeader(e),_=parseInt(gInjectTab_TabLocation),u=0;u<a;++u){var d=g(e,u);if(isSectionHeader(d)||isMultiVoiceTune(d)){o+=d;continue}d=StripTabOne(d),(0==l||1==l&&i)&&(d=StripChordsOne(d)),d=t(d),d=InjectStringBelowTuneHeaderConditional(d,"%%staffsep "+c),d=InjectStringAboveTuneHeaderConditional(d,"%%annotationfont "+r+" "+n),0==_&&(d=InjectStringAboveTuneHeaderConditional(d,"%%musicspace "+s)),o+=d}return o}return p(e)},bambooFluteTabGenerator=function(e){var a=!1,r="",n=null;function t(e){a&&console.log(e)}function s(e){t("Got input:"+e);var a=parseInt(gBambooFluteKey);if(null==(n=l(e)))return"ERROR: Unknown or unsupported key signature";var s=d(e,a);return r=o(e,s)}var c=function(e,a,r,n){this.index=e,this.unNormalizedValue=a,this.normalizedValue=r,this.glyph=n};function l(e){var a,r,n=null,s=e.match(/^K: *([A-G])([b#])? *(.*?)$/m);if(null==s||s.length<3)return null;a=void 0==s[2]?s[1]:s[1]+s[2];var c=/%.*/;if(t("Got base key of '"+a+"' and extra of '"+(r=(r=(r=s[3].toLowerCase()).replace(c,"")).trim())+"'"),""==r||-1!=r.search("maj")||-1!=r.search("ion")?(t("Mode: Ionian (major)"),n=i(a,0)):-1!=r.search("mix")?(t("Mode: Mixolydian"),n=i(a,1)):-1!=r.search("dor")?(t("Mode: Dorian"),n=i(a,2)):-1!=r.search("m")&&-1==r.search("mix")||-1!=r.search("min")||-1!=r.search("aeo")?(t("Mode: Aeolian (minor)"),n=i(a,3)):-1!=r.search("phr")?(t("Mode: Phrygian"),n=i(a,4)):-1!=r.search("loc")?(t("Mode: Locrian"),n=i(a,5)):-1!=r.search("lyd")?(t("Mode: Lydian"),n=i(a,-1)):-1!=r.search("exp")?(t("(Accidentals to be explicitly specified)"),n=i("C",0)):(t("Failed to determine key signature mode"),n=null),null==n)return n;var l=r.match(/_./g),o=r.match(/\^./g);for(note in l)n.flats+=l[note][1].toUpperCase();for(note in o)n.sharps+=o[note][1].toUpperCase();return n}function i(e,a){var r="FCGDAEB",n={sharps:"",flats:""},s=r.indexOf(e[0])-1;if(-2==s)return t("Bad tonic: "+e),null;"b"==e.slice(1)?s-=7:"#"==e.slice(1)&&(s+=7);var c=s-a;return c>7?(t("Too many sharps: "+c),null):c<-7?(t("Too many flats: "+-1*c),null):(c>0?n.sharps=r.slice(0,c):c<0&&(n.flats=r.slice(c)),n.accidentalSharps="",n.accidentalFlats="",n.accidentalNaturals="",n)}function o(e,a){for(var r,n=e,t=0,s=0;s<a.length;++s){var c=a[s].index+t,l=a[s].glyph,i=l.length,o=l.substr(0,i-1),_=l.substr(i-1,i-1),u=(r="-"!=_?'"_'+_+";"+o+'"':'"_ ;'+o+';•"').length;n=n.substr(0,c)+r+n.substr(c),t+=u}return n}function _(e,a,r){for(var n="",t=0;t<r;++t)n+="*";return e.substr(0,a)+n+e.substr(a+r)}function u(e,a){var r="";switch(a){case 0:var n={"G,":"5-","^G,":"#5-","_A,":"#5-","A,":"6-","^A,":"#6-","_B,":"#6-","B,":"7-",C:"1 ","^C":"#1 ",_D:"#1 ",D:"2 ","^D":"#2 ",_E:"#2 ",E:"3 ",F:"4 ","^F":"#4 ",_G:"#4 ",G:"5 ","^G":"#5 ",_A:"#5 ",A:"6 ","^A":"#6 ",_B:"#6 ",B:"7 ",c:"1•","^c":"#1•",_d:"#1•",d:"2•","^d":"#2•",_e:"#2•",e:"3•",f:"4•","^f":"#4•",_g:"#4•",g:"5•","^g":"#5•",_a:"#5•",a:"6•","^a":"#6•",_b:"#6•",b:"7•"};if(!(r=n[e]))return"x ";break;case 1:var n={"G,":"4-","^G,":"#4-","_A,":"#4-","A,":"5-","^A,":"#5-","_B,":"#5-","B,":"6-",C:"#6-","^C":"7-",_D:"7-",D:"1 ","^D":"#1 ",_E:"#1 ",E:"2 ",F:"#2 ","^F":"3 ",_G:"3 ",G:"4 ","^G":"#4 ",_A:"#4 ",A:"5 ","^A":"#5 ",_B:"#5 ",B:"6 ",c:"#6 ","^c":"7 ",_d:"7 ",d:"1•","^d":"#1•",_e:"#1•",e:"2•",f:"#2•","^f":"3•",_g:"3•",g:"4•","^g":"#4•",_a:"#4•",a:"5•","^a":"#5•",_b:"#5•",b:"6•","c'":"#6•","^c'":"7•"};if(!(r=n[e]))return"x ";break;case 2:var n={"G,":"1-","^G,":"#1-","_A,":"#1-","A,":"2-","^A,":"#2-","_B,":"#2-","B,":"3-",C:"4-","^C":"#4-",_D:"#4-",D:"5-","^D":"#5-",_E:"#5-",E:"6-",F:"#6-","^F":"7-",G:"1 ","^G":"#1 ",_A:"#1 ",A:"2 ","^A":"#2 ",_B:"#2 ",B:"3 ",c:"4 ","^c":"#4 ",_d:"#4 ",d:"5 ","^d":"#5 ",_e:"#5 ",e:"6 ",f:"#6 ","^f":"7 ",_g:"7 ",g:"1•","^g":"#1•",_a:"#1•",a:"2•","^a":"#2•",_b:"#2•",b:"3•","c'":"4•","^c'":"#4•","_d'":"#4•","d'":"5•","^d'":"#5•","_e'":"#5•","e'":"6•","f'":"6#•","^f'":"7•","_g'":"7•"};if(!(r=n[e]))return"x ";break;case 3:var n={"A,":"1-","^A,":"#1-","_B,":"#1-","B,":"2-",C:"#2-","^C":"3-",_D:"3-",D:"4-","^D":"#4-",_E:"#4-",E:"5-",F:"#5-","^F":"6-",_G:"6-",G:"6#-","^G":"7-",_A:"7-",A:"1 ","^A":"#1 ",_B:"#1 ",B:"2 ",c:"#2 ","^c":"3 ",_d:"3 ",d:"4 ","^d":"#4 ",_e:"#4 ",e:"5 ",f:"#5 ","^f":"6 ",_g:"6 ",g:"6# ","^g":"7 ",_a:"7 ",a:"1•","^a":"#1•",_b:"#1•",b:"2•","c'":"#2•","^c'":"3•","_d'":"3•","d'":"4•","^d'":"#4•","_e'":"#4•","e'":"5•","f'":"#5•","^f'":"6•","_g'":"6•","g'":"6#•","^g'":"7•","_a'":"7•"};if(!(r=n[e]))return"x "}return r}function d(e,a){for(var r,s,l=e,i=/^\w:.*$/mg;r=i.exec(e);)l=_(l,r.index,r[0].length);for(var o=/"[^"]*"/gm;s=o.exec(l);)for(var d=s.index,g=d+s[0].length,h=d;h<g;++h)l=l.substring(0,h)+"*"+l.substring(h+1);for(o=/\[[^\]|]*\]/g;s=o.exec(l);)for(var d=s.index,g=d+s[0].length,h=d;h<g;++h)l=l.substring(0,h)+"*"+l.substring(h+1);for(o=/![^!\n]*!/gm;s=o.exec(l);)for(var d=s.index,g=d+s[0].length,h=d;h<g;++h)l=l.substring(0,h)+"*"+l.substring(h+1);for(o=/^%%begintext((.|\n)*)%%endtext/gm;s=o.exec(l);)for(var d=s.index,g=d+s[0].length,h=d;h<g;++h)l=l.substring(0,h)+"*"+l.substring(h+1);for(o=/^%.*$/gm;s=o.exec(l);)for(var d=s.index,g=d+s[0].length,h=d;h<g;++h)l=l.substring(0,h)+"*"+l.substring(h+1);t("sanitized input:"+(l=l.replaceAll("!","*")));for(var $=/([=^_]?[a-gA-G][',]?|\|)/g,p=[];s=$.exec(l);){var m=s[1];if("|"==m)n.accidentalFlats="",n.accidentalSharps="",n.accidentalNaturals="";else{var G=f(m);t("UnNormalized="+m+" normalized="+G);var v=u(G,a);p.push(new c(s.index,m,G,v))}}return p}function f(e){var a=e.search(/[A-G]/i);if(-1==a)return t("Failed to find basename for value!"),e;var r=e.substr(a,1).toUpperCase();return"="==e.substr(0,1)?(n.accidentalFlats=n.accidentalFlats.replace(r,""),n.accidentalSharps=n.accidentalSharps.replace(r,""),n.accidentalNaturals+=r,e.substr(1)):"_"==e.substr(0,1)?(n.accidentalFlats+=r,n.accidentalSharps=n.accidentalSharps.replace(r,""),n.accidentalNaturals=n.accidentalNaturals.replace(r,""),e):"^"==e.substr(0,1)?(n.accidentalFlats=n.accidentalFlats.replace(r,""),n.accidentalNaturals=n.accidentalNaturals.replace(r,""),n.accidentalSharps+=r,e):-1!=n.accidentalNaturals.search(r)?e:-1!=n.sharps.search(r)||-1!=n.accidentalSharps.search(r)?"^"+e:-1!=n.flats.search(r)||-1!=n.accidentalFlats.search(r)?"_"+e:e}function g(e){return e.split(/^X:.*$/gm).length-1}function h(e,a){return"X:"+e.split(/^X:/gm)[a+1]}function $(e){var a=e.split(/^X:.*$/gm).length-1,r=gInjectTab_FontFamily,n=gInjectTab_TabFontSize,t=gInjectTab_StaffSep;parseInt(gInjectTab_TabLocation);for(var c=gInjectTab_StripChords,l=FindPreTuneHeader(e),i=0;i<a;++i){var o=h(e,i);if(isSectionHeader(o)||isMultiVoiceTune(o)){l+=o;continue}switch(o=StripTabOne(o),c&&(o=StripChordsOne(o)),o=s(o),o=InjectStringBelowTuneHeaderConditional(o,"%%staffsep "+t),parseInt(gBambooFluteKey)){case 0:o=InjectStringBelowTuneHeaderConditional(o,"%%text 1=C"),o=InjectStringBelowTuneHeaderConditional(o,"%%text ");break;case 1:o=InjectStringBelowTuneHeaderConditional(o,"%%text 1=D"),o=InjectStringBelowTuneHeaderConditional(o,"%%text ");break;case 2:o=InjectStringBelowTuneHeaderConditional(o,"%%text 1=G"),o=InjectStringBelowTuneHeaderConditional(o,"%%text ");break;case 3:o=InjectStringBelowTuneHeaderConditional(o,"%%text 1=A"),o=InjectStringBelowTuneHeaderConditional(o,"%%text ")}o=InjectStringAboveTuneHeaderConditional(o,"%%annotationfont "+r+" "+n),l+=o}return l}return $(e)},ceoltasABCTransformer=function(e,a,r){var n=!1,t="",s=null;function c(e){n&&console.log(e)}function l(e,a,r){if(c("Got input:"+e),null==(s=o(e)))return"ERROR: Unknown or unsupported key signature";var n=g(e,a,r);return t=u(e,n)}var i=function(e,a,r,n){this.index=e,this.unNormalizedValue=a,this.normalizedValue=r,this.glyph=n};function o(e){var a,r,n=null,t=e.match(/^K: *([A-G])([b#])? *(.*?)$/m);if(null==t||t.length<3)return null;a=void 0==t[2]?t[1]:t[1]+t[2];var s=/%.*/;if(c("Got base key of '"+a+"' and extra of '"+(r=(r=(r=t[3].toLowerCase()).replace(s,"")).trim())+"'"),""==r||-1!=r.search("maj")||-1!=r.search("ion")?(c("Mode: Ionian (major)"),n=_(a,0)):-1!=r.search("mix")?(c("Mode: Mixolydian"),n=_(a,1)):-1!=r.search("dor")?(c("Mode: Dorian"),n=_(a,2)):-1!=r.search("m")&&-1==r.search("mix")||-1!=r.search("min")||-1!=r.search("aeo")?(c("Mode: Aeolian (minor)"),n=_(a,3)):-1!=r.search("phr")?(c("Mode: Phrygian"),n=_(a,4)):-1!=r.search("loc")?(c("Mode: Locrian"),n=_(a,5)):-1!=r.search("lyd")?(c("Mode: Lydian"),n=_(a,-1)):-1!=r.search("exp")?(c("(Accidentals to be explicitly specified)"),n=_("C",0)):(c("Failed to determine key signature mode"),n=null),null==n)return n;var l=r.match(/_./g),i=r.match(/\^./g);for(note in l)n.flats+=l[note][1].toUpperCase();for(note in i)n.sharps+=i[note][1].toUpperCase();return n}function _(e,a){var r="FCGDAEB",n={sharps:"",flats:""},t=r.indexOf(e[0])-1;if(-2==t)return c("Bad tonic: "+e),null;"b"==e.slice(1)?t-=7:"#"==e.slice(1)&&(t+=7);var s=t-a;return s>7?(c("Too many sharps: "+s),null):s<-7?(c("Too many flats: "+-1*s),null):(s>0?n.sharps=r.slice(0,s):s<0&&(n.flats=r.slice(s)),n.accidentalSharps="",n.accidentalFlats="",n.accidentalNaturals="",n)}function u(e,a){for(var r,n,t,s,c,l=e,i=0,o=0;o<a.length;++o)r=a[o].index+i,n=a[o].glyph,t=a[o].unNormalizedValue,glyphLen=n.length,s=t.length,l=l.substr(0,r)+n+l.substr(r+s),i+=c=glyphLen-s;return l}function d(e,a,r){for(var n="",t=0;t<r;++t)n+="*";return e.substr(0,a)+n+e.substr(a+r)}function f(e,a,r){if(r){var n={"D,":"D,","^D,":"D#,","_E,":"Eb,","E,":"E,","^E,":"E#,","_F,":"Fb,","F,":"F,","^F,":"F#,","_G,":"Gb,","G,":"G,","^G,":"G#,","_A,":"Ab,","A,":"A,","^A,":"A#,","_B,":"Bb,","B,":"B,","^B,":"B#,",_C:"Cb,",C:"C,","^C":"C,#",_D:"Db",D:"D","^D":"D#",_E:"Eb",E:"E","^E":"E#",_F:"Fb",F:"F","^F":"F#",_G:"Gb",G:"G","^G":"G#",_A:"Ab",A:"A","^A":"A#",_B:"Bb",B:"B","^B":"B#",_c:"Cb",c:"C","^c":"C#",_d:"Db'",d:"D'","^d":"D#'",_e:"Eb'",e:"E'","^e":"E#'",_f:"Fb'",f:"F'","^f":"F#'",_g:"Gb'",g:"G'","^g":"G#'",_a:"Ab'",a:"A'","^a":"A#'",_b:"Bb'",b:"B'","^b":"B#'","_c'":"Cb'","c'":"C'","^c'":"C#'","_d'":"Db''","d'":"D''","^d'":"D#''","_e'":"Eb''","e'":"E''","^e'":"E#''","_f'":"Fb''","f'":"F''","^f'":"F#''","_g'":"Gb''","g'":"G''","=D,":"D,","=E,":"E,","=F,":"F,","=G,":"G,","=A,":"A,","=B,":"B,","=C":"C,","=D":"D","=E":"E","=F":"F","=G":"G","=A":"A","=B":"B","=c":"C","=d":"D'","=e":"E'","=f":"F'","=g":"G'","=a":"A'","=b":"B'","=c'":"C'","=d'":"D''","=e'":"E''","=f'":"F''","=g'":"G''","C'":"C","^C'":"C#","_D'":"Db'","D'":"D'","^D'":"D#'","_E'":"Eb'","E'":"E'","F'":"F'","^F'":"F#'","_G'":"Gb'","G'":"G'","^G'":"G#'","_A'":"Ab'","A'":"A'","^A'":"A#'","_B'":"Bb'","B'":"B'","C''":"C'","^C''":"C#'","_D''":"Db''","D''":"D''","^D''":"D#''","_E''":"Eb''","E''":"E''","F''":"F''","^F''":"F#''","_G''":"Gb''","G''":"G''","=C'":"C","=D'":"D'","=E'":"E'","=F'":"F'","=G'":"G'","=A'":"A'","=B'":"B'","=C''":"C'","=D''":"D''","=E''":"E''","=F''":"F''","=G''":"G''"},t=n[e];return t||"x "}if(a){var n={"D,":"D,","^D,":"^D,","E,":"E,","F,":"F,","^F,":"^F,","_G,":"_G,","G,":"G,","^G,":"^G,","_A,":"_A,","A,":"A,","^A,":"^A,","_B,":"_B,","B,":"B,","^B,":"^B,",_C:"_C",C:"C","^C":"^C",_D:"_D",D:"D","^D":"^D",_E:"_E",E:"E","^E":"^E",_F:"_F",F:"F","^F":"^F",_G:"_G",G:"G","^G":"^G",_A:"_A",A:"A","^A":"^A",_B:"_B",B:"B","^B":"^B",_C:"_c","C'":"c","^C'":"^c","_D'":"_d","D'":"d","^D'":"^d","_E'":"_e","E'":"e","^E'":"^e","_F'":"_f","F'":"f","^F'":"^f","_G'":"_g","G'":"g","^G'":"^g","_A'":"_a","A'":"a","^A'":"^a","_B'":"_b","B'":"b","^B'":"^b","_C''":"_c'","C''":"c'","^C''":"^c'","_D''":"_d'","D''":"d'","^D''":"^d'","_E''":"_e'","E''":"e'","^E'":"^e'","_F'":"_f'","F''":"f'","^F''":"^f'","_G''":"_g'","G''":"g'","=D,":"=D,","=E,":"=E,","=F,":"=F,","=G,":"=G,","=A,":"=A,","=B,":"=B,","=C":"=C","=D":"=D","=E":"=E","=F":"=F","=G":"=G","=A":"=A","=B":"=B","=C'":"=c","=D'":"=d","=E'":"=e","=F'":"=f","=G'":"=g","=A'":"=a","=B'":"=b","=C''":"=c'","=D''":"=d'","=E''":"=e'","=F''":"=f'","=G''":"=g'",c:"c","^c":"^c",_d:"_d",d:"d","^d":"^d",_e:"_e",e:"e",f:"f","^f":"^f",_g:"_g",g:"g","^g":"^g",_a:"_a",a:"a","^a":"^a",_b:"_b",b:"b","c'":"c'","^c'":"^c'","_d'":"_d'","d'":"d'","^d'":"^d'","_e'":"_e'","e'":"e'","f'":"f'","^f'":"^f'","_g'":"_g'","g'":"g'","=c":"=c","=d":"=d","=e":"=e","=f":"=f","=g":"=g","=a":"=a","=b":"=b","=c'":"=c'","=d'":"=d'","=e'":"=e'","=f'":"=f'","=g'":"=g'"},t=n[e];return t||"x "}var n={"D,":"D,","^D,":"^D,","_E,":"_E,","E,":"E,","^E,":"^E,","_F,":"_F,","F,":"F,","^F,":"^F,","_G,":"_G,","G,":"G,","^G,":"^G,","_A,":"_A,","A,":"A,","^A,":"^A,","_B,":"_B,","B,":"B,","^B,":"^B,",_C:"_C",C:"C","^C":"^C",_D:"_D",D:"D","^D":"^D",_E:"_E",E:"E","^E":"^E",_F:"_F",F:"F","^F":"^F",_G:"_G",G:"G","^G":"^G",_A:"_A",A:"A","^A":"^A",_B:"_B",B:"B","^B":"^B",_c:"_C'",c:"C'","^c":"^C'",_d:"_D'",d:"D'","^d":"^D'",_e:"_E'",e:"E'","^e":"^E'",_f:"_F'",f:"F'","^f":"^F'",_g:"_G'",g:"G'","^g":"^G'",_a:"_A'",a:"A'","^a":"^A'",_b:"_B'",b:"B'","^b":"^B'","_c'":"_C''","c'":"C''","^c'":"^C''","_d'":"_D''","d'":"D''","^d'":"^D''","_e'":"_E''","e'":"E''","^e'":"^E''","_f'":"_F''","f'":"F''","^f'":"^F''","_g'":"_G''","g'":"G''","=D,":"=D,","=E,":"=E,","=F,":"=F,","=G,":"=G,","=A,":"=A,","=B,":"=B,","=C":"=C,","=D":"=D","=E":"=E","=F":"=F","=G":"=G","=A":"=A","=B":"=B","=c":"=C","=d":"=D'","=e":"=E'","=f":"=F'","=g":"=G'","=a":"=A'","=b":"=B'","=c'":"=C''","=d'":"=D''","=e'":"=E''","=f'":"=F''","=g'":"=G''","C'":"C'","^C'":"^C'","_D'":"_D'","D'":"D'","^D'":"^D'","_E'":"_E'","E'":"E'","F'":"F'","^F'":"^F'","_G'":"_G'","G'":"G'","^G'":"^G'","_A'":"_A'","A'":"A'","^A'":"^A'","_B'":"_B'","B'":"B'","C''":"C''","^C''":"^C''","_D''":"_D''","D''":"D''","^D''":"^D''","_E''":"_E''","E''":"E''","F''":"F''","^F''":"^F''","_G''":"_G''","G''":"G''","=C'":"=C'","=D'":"=D'","=E'":"=E'","=F'":"=F'","=G'":"=G'","=A'":"=A'","=B'":"=B'","=C''":"=C''","=D''":"=D''","=E''":"=E''","=F''":"=F''","=G''":"=G''"},t=n[e];return t||"x "}function g(e,a,r){for(var n,t,l=e,o=/^\w:.*$/mg;n=o.exec(e);)l=d(l,n.index,n[0].length);for(var _=/"[^"]*"/gm;t=_.exec(l);)for(var u=t.index,g=u+t[0].length,$=u;$<g;++$)l=l.substring(0,$)+"*"+l.substring($+1);for(_=/\[[^\]|]*\]/g;t=_.exec(l);)for(var u=t.index,g=u+t[0].length,$=u;$<g;++$)l=l.substring(0,$)+"*"+l.substring($+1);for(_=/![^!\n]*!/gm;t=_.exec(l);)for(var u=t.index,g=u+t[0].length,$=u;$<g;++$)l=l.substring(0,$)+"*"+l.substring($+1);for(_=/^%%begintext((.|\n)*)%%endtext/gm;t=_.exec(l);)for(var u=t.index,g=u+t[0].length,$=u;$<g;++$)l=l.substring(0,$)+"*"+l.substring($+1);for(_=/^%.*$/gm;t=_.exec(l);)for(var u=t.index,g=u+t[0].length,$=u;$<g;++$)l=l.substring(0,$)+"*"+l.substring($+1);c("sanitized input:"+(l=l.replaceAll("!","*")));for(var p=/([=^_]?[a-gA-G][',]?|\|)/g,m=[];t=p.exec(l);){var G=t[1];if("|"==G)s.accidentalFlats="",s.accidentalSharps="",s.accidentalNaturals="";else{var v=h(G);c("UnNormalized="+G+" normalized="+v);var A=f(G,a,r);m.push(new i(t.index,G,v,A))}}return m}function h(e){var a=e.search(/[A-G]/i);if(-1==a)return c("Failed to find basename for value!"),e;var r=e.substr(a,1).toUpperCase();return"="==e.substr(0,1)?(s.accidentalFlats=s.accidentalFlats.replace(r,""),s.accidentalSharps=s.accidentalSharps.replace(r,""),s.accidentalNaturals+=r,e.substr(1)):"_"==e.substr(0,1)?(s.accidentalFlats+=r,s.accidentalSharps=s.accidentalSharps.replace(r,""),s.accidentalNaturals=s.accidentalNaturals.replace(r,""),e):"^"==e.substr(0,1)?(s.accidentalFlats=s.accidentalFlats.replace(r,""),s.accidentalNaturals=s.accidentalNaturals.replace(r,""),s.accidentalSharps+=r,e):-1!=s.accidentalNaturals.search(r)?e:-1!=s.sharps.search(r)||-1!=s.accidentalSharps.search(r)?"^"+e:-1!=s.flats.search(r)||-1!=s.accidentalFlats.search(r)?"_"+e:e}function $(e){return e.split(/^X:.*$/gm).length-1}function p(e,a){return"X:"+e.split(/^X:/gm)[a+1]}function m(e,a){for(var n=$(e),t=FindPreTuneHeader(e),s=0;s<n;++s){var c=p(e,s);if(isSectionHeader(c)||isMultiVoiceTune(c)){t+=c;continue}c=l(c,a,r),t+=c}return t}return m(e,a)},fiddleFingeringsGenerator=function(e,a){var r=!1,n="",t=null;function s(e){r&&console.log(e)}function c(e){if(s("Got input:"+e),null==(t=i(e)))return"ERROR: Unknown or unsupported key signature";var a=$(e);return n=_(e,a)}var l=function(e,a,r,n){this.index=e,this.unNormalizedValue=a,this.normalizedValue=r,this.glyph=n};function i(e){var a,r,n=null,t=e.match(/^K: *([A-G])([b#])? *(.*?)$/m);if(null==t||t.length<3)return null;a=void 0==t[2]?t[1]:t[1]+t[2];var c=/%.*/;if(s("Got base key of '"+a+"' and extra of '"+(r=(r=(r=t[3].toLowerCase()).replace(c,"")).trim())+"'"),""==r||-1!=r.search("maj")||-1!=r.search("ion")?(s("Mode: Ionian (major)"),n=o(a,0)):-1!=r.search("mix")?(s("Mode: Mixolydian"),n=o(a,1)):-1!=r.search("dor")?(s("Mode: Dorian"),n=o(a,2)):-1!=r.search("m")&&-1==r.search("mix")||-1!=r.search("min")||-1!=r.search("aeo")?(s("Mode: Aeolian (minor)"),n=o(a,3)):-1!=r.search("phr")?(s("Mode: Phrygian"),n=o(a,4)):-1!=r.search("loc")?(s("Mode: Locrian"),n=o(a,5)):-1!=r.search("lyd")?(s("Mode: Lydian"),n=o(a,-1)):-1!=r.search("exp")?(s("(Accidentals to be explicitly specified)"),n=o("C",0)):(s("Failed to determine key signature mode"),n=null),null==n)return n;var l=r.match(/_./g),i=r.match(/\^./g);for(note in l)n.flats+=l[note][1].toUpperCase();for(note in i)n.sharps+=i[note][1].toUpperCase();return n}function o(e,a){var r="FCGDAEB",n={sharps:"",flats:""},t=r.indexOf(e[0])-1;if(-2==t)return s("Bad tonic: "+e),null;"b"==e.slice(1)?t-=7:"#"==e.slice(1)&&(t+=7);var c=t-a;return c>7?(s("Too many sharps: "+c),null):c<-7?(s("Too many flats: "+-1*c),null):(c>0?n.sharps=r.slice(0,c):c<0&&(n.flats=r.slice(c)),n.accidentalSharps="",n.accidentalFlats="",n.accidentalNaturals="",n)}function _(e,a){for(var r=e,n=0,t=parseInt(gInjectTab_TabLocation),s=0;s<a.length;++s){var c=a[s].index+n,l=a[s].glyph;switch(l.length,t){case 0:var i='"^'+l+'"';break;case 1:var i='"_'+l+'"'}var o=i.length;r=r.substr(0,c)+i+r.substr(c),n+=o}return r}function u(e,a,r){for(var n="",t=0;t<r;++t)n+="*";return e.substr(0,a)+n+e.substr(a+r)}function d(e){var a={"G,":"0","^G,":"1","_A,":"1","A,":"1","^A,":"2","_B,":"2","B,":"2",C:"3","^C":"3",_D:"3",D:"0","^D":"1",_E:"1",E:"1",F:"2","^F":"2",_G:"2",G:"3","^G":"3",_A:"3",A:"0","^A":"1",_B:"1",B:"1",c:"2","^c":"2",_d:"2",d:"3","^d":"3",_e:"3",e:"0",f:"1","^f":"1",_g:"1",g:"2","^g":"2",_a:"2",a:"3","^a":"3",_b:"3",b:"4","c'":"4","^c'":"4","_d'":"4","d'":"4"}[e];return a||"x "}function f(e){var a={"G,":"G0","^G,":"G1","_A,":"G1","A,":"G1","^A,":"G2","_B,":"G2","B,":"G2",C:"G3","^C":"G3",_D:"G3",D:"D0","^D":"D1",_E:"D1",E:"D1",F:"D2","^F":"D2",_G:"D2",G:"D3","^G":"D3",_A:"D3",A:"A0","^A":"A1",_B:"A1",B:"A1",c:"A2","^c":"A2",_d:"A2",d:"A3","^d":"A3",_e:"A3",e:"E0",f:"E1","^f":"E1",_g:"E1",g:"E2","^g":"E2",_a:"E2",a:"E3","^a":"E3",_b:"E3",b:"E4","c'":"E4","^c'":"E4","_d'":"E4","d'":"E4"}[e];return a||"x "}function g(e){var a={"G,":"G;0","^G,":"G;1","_A,":"G;1","A,":"G;1","^A,":"G;2","_B,":"G;2","B,":"G;2",C:"G;3","^C":"G;3",_D:"G;3",D:"D;0","^D":"D;1",_E:"D;1",E:"D;1",F:"D;2","^F":"D;2",_G:"D;2",G:"D;3","^G":"D;3",_A:"D;3",A:"A;0","^A":"A;1",_B:"A;1",B:"A;1",c:"A;2","^c":"A;2",_d:"A;2",d:"A;3","^d":"A;3",_e:"A;3",e:"E;0",f:"E;1","^f":"E;1",_g:"E;1",g:"E;2","^g":"E;2",_a:"E;2",a:"E;3","^a":"E;3",_b:"E;3",b:"E;4","c'":"E;4","^c'":"E;4","_d'":"E;4","d'":"E;4"}[e];return a||"x "}function h(e){var a={"G,":"0;G","^G,":"1;G","_A,":"1;G","A,":"1;G","^A,":"2;G","_B,":"2;G","B,":"2;G",C:"3;G","^C":"3;G",_D:"3;G",D:"0;D","^D":"1;D",_E:"1;D",E:"1;D",F:"2;D","^F":"2;D",_G:"2;D",G:"3;D","^G":"3;D",_A:"3;D",A:"0;A","^A":"1;A",_B:"1;A",B:"1;A",c:"2;A","^c":"2;A",_d:"2;A",d:"3;A","^d":"3;A",_e:"3;A",e:"0;E",f:"1;E","^f":"1;E",_g:"1;E",g:"2;E","^g":"2;E",_a:"2;E",a:"3;E","^a":"3;E",_b:"3;E",b:"4;E","c'":"4;E","^c'":"4;E","_d'":"4;E","d'":"4;E"}[e];return a||"x "}function $(e,r){for(var n=e,c=/^\w:.*$/mg;A=c.exec(e);)n=u(n,A.index,A[0].length);for(var i=/"[^"]*"/gm;F=i.exec(n);)for(var o=F.index,_=o+F[0].length,$=o;$<_;++$)n=n.substring(0,$)+"*"+n.substring($+1);for(i=/\[[^\]|]*\]/g;F=i.exec(n);)for(var o=F.index,_=o+F[0].length,$=o;$<_;++$)n=n.substring(0,$)+"*"+n.substring($+1);for(i=/![^!\n]*!/gm;F=i.exec(n);)for(var o=F.index,_=o+F[0].length,$=o;$<_;++$)n=n.substring(0,$)+"*"+n.substring($+1);for(i=/^%%begintext((.|\n)*)%%endtext/gm;F=i.exec(n);)for(var o=F.index,_=o+F[0].length,$=o;$<_;++$)n=n.substring(0,$)+"*"+n.substring($+1);for(i=/^%.*$/gm;F=i.exec(n);)for(var o=F.index,_=o+F[0].length,$=o;$<_;++$)n=n.substring(0,$)+"*"+n.substring($+1);s("sanitized input:"+(n=n.replaceAll("!","*")));for(var m=/([=^_]?[a-gA-G][',]?|\|)/g,G=[];F=m.exec(n);){var v=F[1];if("|"==v)t.accidentalFlats="",t.accidentalSharps="",t.accidentalNaturals="";else{var A,F,x,D=p(v);switch(s("UnNormalized="+v+" normalized="+D),a){case 0:default:x=d(D);break;case 1:x=f(D);break;case 2:x=g(D);break;case 3:x=h(D)}G.push(new l(F.index,v,D,x))}}return G}function p(e){var a=e.search(/[A-G]/i);if(-1==a)return s("Failed to find basename for value!"),e;var r=e.substr(a,1).toUpperCase();return"="==e.substr(0,1)?(t.accidentalFlats=t.accidentalFlats.replace(r,""),t.accidentalSharps=t.accidentalSharps.replace(r,""),t.accidentalNaturals+=r,e.substr(1)):"_"==e.substr(0,1)?(t.accidentalFlats+=r,t.accidentalSharps=t.accidentalSharps.replace(r,""),t.accidentalNaturals=t.accidentalNaturals.replace(r,""),e):"^"==e.substr(0,1)?(t.accidentalFlats=t.accidentalFlats.replace(r,""),t.accidentalNaturals=t.accidentalNaturals.replace(r,""),t.accidentalSharps+=r,e):-1!=t.accidentalNaturals.search(r)?e:-1!=t.sharps.search(r)||-1!=t.accidentalSharps.search(r)?"^"+e:-1!=t.flats.search(r)||-1!=t.accidentalFlats.search(r)?"_"+e:e}function m(e){return e.split(/^X:.*$/gm).length-1}function G(e,a){return"X:"+e.split(/^X:/gm)[a+1]}function v(e){for(var a=e.split(/^X:.*$/gm).length-1,r=gInjectTab_MusicSpace,n=gInjectTab_FontFamily,t=gInjectTab_TabFontSize,s=gInjectTab_StaffSep,l=parseInt(gInjectTab_TabLocation),i=gInjectTab_StripChords,o=FindPreTuneHeader(e),_=parseInt(gInjectTab_TabLocation),u=0;u<a;++u){var d=G(e,u);if(isSectionHeader(d)||isMultiVoiceTune(d)){o+=d;continue}d=StripTabOne(d),(0==l||1==l&&i)&&(d=StripChordsOne(d)),d=c(d),d=InjectStringBelowTuneHeaderConditional(d,"%%staffsep "+s),d=InjectStringAboveTuneHeaderConditional(d,"%%annotationfont "+n+" "+t),0==_&&(d=InjectStringAboveTuneHeaderConditional(d,"%%musicspace "+r)),o+=d}return o}return v(e)},MDTablatureGenerator=function(e){var a=!1,r="",n=null;function t(e){a&&console.log(e)}function s(e){t("Got input:"+e);var a=parseInt(gMDulcimerStyle);if(null==(n=l(e)))return"ERROR: Unknown or unsupported key signature";var s=d(e,a);return r=o(e,s)}var c=function(e,a,r,n){this.index=e,this.unNormalizedValue=a,this.normalizedValue=r,this.glyph=n};function l(e){var a,r,n=null,s=e.match(/^K: *([A-G])([b#])? *(.*?)$/m);if(null==s||s.length<3)return null;a=void 0==s[2]?s[1]:s[1]+s[2];var c=/%.*/;if(t("Got base key of '"+a+"' and extra of '"+(r=(r=(r=s[3].toLowerCase()).replace(c,"")).trim())+"'"),""==r||-1!=r.search("maj")||-1!=r.search("ion")?(t("Mode: Ionian (major)"),n=i(a,0)):-1!=r.search("mix")?(t("Mode: Mixolydian"),n=i(a,1)):-1!=r.search("dor")?(t("Mode: Dorian"),n=i(a,2)):-1!=r.search("m")&&-1==r.search("mix")||-1!=r.search("min")||-1!=r.search("aeo")?(t("Mode: Aeolian (minor)"),n=i(a,3)):-1!=r.search("phr")?(t("Mode: Phrygian"),n=i(a,4)):-1!=r.search("loc")?(t("Mode: Locrian"),n=i(a,5)):-1!=r.search("lyd")?(t("Mode: Lydian"),n=i(a,-1)):-1!=r.search("exp")?(t("(Accidentals to be explicitly specified)"),n=i("C",0)):(t("Failed to determine key signature mode"),n=null),null==n)return n;var l=r.match(/_./g),o=r.match(/\^./g);for(note in l)n.flats+=l[note][1].toUpperCase();for(note in o)n.sharps+=o[note][1].toUpperCase();return n}function i(e,a){var r="FCGDAEB",n={sharps:"",flats:""},s=r.indexOf(e[0])-1;if(-2==s)return t("Bad tonic: "+e),null;"b"==e.slice(1)?s-=7:"#"==e.slice(1)&&(s+=7);var c=s-a;return c>7?(t("Too many sharps: "+c),null):c<-7?(t("Too many flats: "+-1*c),null):(c>0?n.sharps=r.slice(0,c):c<0&&(n.flats=r.slice(c)),n.accidentalSharps="",n.accidentalFlats="",n.accidentalNaturals="",n)}function o(e,a){for(var r,n=e,t=0,s=0;s<a.length;++s){var c=a[s].index+t,l=(r='"_'+a[s].glyph+'"').length;n=n.substr(0,c)+r+n.substr(c),t+=l}return n}function _(e,a,r){for(var n="",t=0;t<r;++t)n+="*";return e.substr(0,a)+n+e.substr(a+r)}function u(e,a){switch(a){case 0:var r={"D,":" ; ;0","E,":" ; ;1","^F,":" ; ;2","_G,":" ; ;2","G,":" ; ;3","^G,":" ;6+; ","_A,":" ;6+; ","A,":" ; ;4","B,":" ; ;5",C:" ; ;6","^C":" ; ;6+",_D:" ; ;6+",D:" ; ;0",E:" ; ;1","^F":" ; ;2",_G:" ; ;2",G:" ; ;3","^G":" ;6+; ",_A:" ;6+; ",A:" ; ;4",B:" ; ;5",c:" ; ;6","^c":" ; ;6+",_d:" ; ;6+",d:" ; ;7",e:" ; ;8","^f":" ; ;9",_g:" ; ;9",g:" ; ;10","^g":" ;6+; ",_a:" ;6+; ",a:" ; ;11",b:" ; ;12","c'":" ; ;6","^c'":" ; ;6+","_d'":" ; ;6+","d'":" ; ;7","e'":" ; ;8","^f'":" ; ;9","_g'":" ; ;9","g'":" ; ;10"}[e];if(!r)return"x;x;x";return gMDulcimerUseDashForOpenString&&(r=r.replaceAll(" ","-")),r;case 1:var r={"D,":"0; ; ","E,":"1; ; ","^F,":"2; ; ","_G,":"2; ; ","G,":"3; ; ","^G,":" ;6+; ","_A,":" ;6+; ","A,":" ;0; ","B,":" ;1; ",C:"6; ; ","^C":" ;2; ",_D:" ;2; ",D:"0; ; ",E:"1; ; ","^F":"2; ; ",_G:"2; ; ",G:"3; ; ","^G":" ;6+; ",_A:" ;6+; ",A:" ;0; ",B:" ;1; ",c:"6; ; ","^c":" ;2; ",_d:" ;2; ",d:" ; ;0",e:" ; ;1","^f":" ; ;2",_g:" ; ;2",g:" ; ;3","^g":" ;6+; ",_a:" ;6+; ",a:" ; ;4",b:" ; ;5","c'":" ; ;6","^c'":" ; ;6+","_d'":" ; ;6+","d'":" ; ;7","e'":" ; ;8","^f'":" ; ;9","_g'":" ; ;9","g'":" ; ;10"}[e];if(gMDulcimerUseDashForOpenString&&(r=r.replaceAll(" ","-")),!r)return"x;x;x";return r;case 2:var r={"D,":" ; ;0","E,":" ; ;1","F,":" ;6; ","^F,":" ; ;2","_G,":" ; ;2","G,":" ; ;3","A,":" ; ;4","B,":" ; ;5",C:" ;3; ","^C":" ; ;6+",_D:" ; ;6+",D:" ; ;0",E:" ; ;1",F:" ;6; ","^F":" ; ;2",_G:" ; ;2",G:" ; ;3",A:" ; ;4",B:" ; ;5",c:" ; ;6","^c":" ; ;6+",_d:" ; ;6+",d:" ; ;7",e:" ; ;8",f:" ;6; ","^f":" ; ;9",_g:" ; ;9",g:" ; ;10",a:" ; ;11",b:" ; ;12","c'":" ; ;6","^c'":" ; ;6+","_d'":" ; ;6+","d'":" ; ;7","e'":" ; ;8","f'":" ;6; ","^f'":" ; ;9","_g'":" ; ;9","g'":" ; ;10"}[e];if(!r)return"x;x;x";return gMDulcimerUseDashForOpenString&&(r=r.replaceAll(" ","-")),r;case 3:var r={"D,":"0; ; ","E,":"1; ; ","F,":" ;6; ","^F,":"2; ; ","_G,":"2; ; ","G,":" ;0; ","A,":" ;1; ","B,":" ;2; ",C:" ;3; ","^C":"6+; ; ",_D:"6+; ; ",D:"0; ; ",E:"1; ; ",F:" ;6; ","^F":"2; ; ",_G:"2; ; ",G:" ;0; ",A:" ;1; ",B:" ;2; ",c:" ;3; ","^c":"6+; ; ",_d:"6+; ; ",d:" ; ;0",e:" ; ;1",f:" ;6; ","^f":" ; ;2",_g:" ; ;2",g:" ; ;3",a:" ; ;4",b:" ; ;5","c'":" ; ;6","^c'":" ; ;6+","_d'":" ; ;6+","d'":" ; ;7","e'":" ; ;8","f'":" ;6; ","^f'":" ; ;9","_g'":" ; ;9","g'":" ; ;10"}[e];if(!r)return"x;x;x";return gMDulcimerUseDashForOpenString&&(r=r.replaceAll(" ","-")),r;case 4:var r={"G,":"3; ; ","^G,":" ; ;6+","_A,":" ; ;6+","A,":" ; ;0","B,":" ; ;1",C:"6; ; ","^C":" ; ;2",_D:" ; ;2",D:"0; ; ",E:"1; ; ","^F":"2; ; ",_G:"2; ; ",G:"3 ; ;","^G":" ; ;6+",_A:" ; ;6+",A:" ; ;0",B:" ; ;1",c:"6; ; ","^c":" ; ;2",_d:" ; ;2",d:" ; ;3",e:" ; ;4","^f":" ; ;5",_g:" ; ;5",g:" ; ;6","^g":" ; ;6+",_a:" ; ;6+",a:" ; ;7",b:" ; ;8","c'":"6; ; ","^c'":" ; ;9","_d'":" ; ;9","d'":" ; ;10","e'":" ; ;11","^f'":" ; ;12","_g'":" ; ;12"}[e];if(!r)return"x;x;x";return gMDulcimerUseDashForOpenString&&(r=r.replaceAll(" ","-")),r;case 5:var r=" ; ; ";return gMDulcimerUseDashForOpenString&&(r="-;-;-"),r}}function d(e,a){for(var r,s,l=e,i=/^\w:.*$/mg;r=i.exec(e);)l=_(l,r.index,r[0].length);for(var o=/"[^"]*"/gm;s=o.exec(l);)for(var d=s.index,g=d+s[0].length,h=d;h<g;++h)l=l.substring(0,h)+"*"+l.substring(h+1);for(o=/\[[^\]|]*\]/g;s=o.exec(l);)for(var d=s.index,g=d+s[0].length,h=d;h<g;++h)l=l.substring(0,h)+"*"+l.substring(h+1);for(o=/![^!\n]*!/gm;s=o.exec(l);)for(var d=s.index,g=d+s[0].length,h=d;h<g;++h)l=l.substring(0,h)+"*"+l.substring(h+1);for(o=/^%%begintext((.|\n)*)%%endtext/gm;s=o.exec(l);)for(var d=s.index,g=d+s[0].length,h=d;h<g;++h)l=l.substring(0,h)+"*"+l.substring(h+1);for(o=/^%.*$/gm;s=o.exec(l);)for(var d=s.index,g=d+s[0].length,h=d;h<g;++h)l=l.substring(0,h)+"*"+l.substring(h+1);t("sanitized input:"+(l=l.replaceAll("!","*")));for(var $=/([=^_]?[a-gA-G][',]?|\|)/g,p=[];s=$.exec(l);){var m=s[1];if("|"==m)n.accidentalFlats="",n.accidentalSharps="",n.accidentalNaturals="";else{var G=f(m);t("UnNormalized="+m+" normalized="+G);var v=u(G,a);p.push(new c(s.index,m,G,v))}}return p}function f(e){var a=e.search(/[A-G]/i);if(-1==a)return t("Failed to find basename for value!"),e;var r=e.substr(a,1).toUpperCase();return"="==e.substr(0,1)?(n.accidentalFlats=n.accidentalFlats.replace(r,""),n.accidentalSharps=n.accidentalSharps.replace(r,""),n.accidentalNaturals+=r,e.substr(1)):"_"==e.substr(0,1)?(n.accidentalFlats+=r,n.accidentalSharps=n.accidentalSharps.replace(r,""),n.accidentalNaturals=n.accidentalNaturals.replace(r,""),e):"^"==e.substr(0,1)?(n.accidentalFlats=n.accidentalFlats.replace(r,""),n.accidentalNaturals=n.accidentalNaturals.replace(r,""),n.accidentalSharps+=r,e):-1!=n.accidentalNaturals.search(r)?e:-1!=n.sharps.search(r)||-1!=n.accidentalSharps.search(r)?"^"+e:-1!=n.flats.search(r)||-1!=n.accidentalFlats.search(r)?"_"+e:e}function g(e){return e.split(/^X:.*$/gm).length-1}function h(e){let a=/^(X:|T:|M:|K:|L:|Q:|W:|Z:|R:|C:|A:|O:|P:|N:|G:|H:|B:|D:|F:|S:|I:|:[A-Za-z]:)[^\r\n]*\r?\n?/gm,r=e.replace(a,"");return r}function $(e,a){for(var r,n=e,t=h(e=e.trim()),s=(t=t.trim()).split("\n"),c=s.length,l=!1,i=0;i<c;++i)if(0!=(r=s[i]).indexOf("%")){l=!0;var o=t.indexOf(r);t=t.substring(o);break}if(!l)return n;var _=e.indexOf(r);return e=e.substring(0,_),e+=a,e+="\n"+t+"\n\n"}function p(e,a){return"X:"+e.split(/^X:/gm)[a+1]}function m(e){var a=e.split(/^X:.*$/gm).length-1,r=gInjectTab_FontFamily,n=gInjectTab_TabFontSize,t=gInjectTab_StaffSep;parseInt(gInjectTab_TabLocation);var c=gInjectTab_StripChords,l=FindPreTuneHeader(e);gExcludedFromMDSolution=[];for(var i=0;i<a;++i){var o=p(e,i);if(isSectionHeader(o)||isMultiVoiceTune(o)){l+=o;continue}if(o=StripOrnamentsOne(o),o=StripTabOne(o),c&&(o=StripChordsOne(o)),o=s(o),o=InjectStringBelowTuneHeaderConditional(o,"%%staffsep "+t),o=InjectStringAboveTuneHeaderConditional(o,"%%annotationfont "+r+" "+n),gMDulcimerStripBadTunes&&-1!=o.indexOf('"_x;x;x"')){var _=getTuneTitle(o);gExcludedFromMDSolution.push(_),o=""}l+=o}return l}return m(e)},shapeNoteGenerator=function(e){var a=!1,r="",n=null,t=null,s="Major";function c(e){a&&console.log(e)}function l(e){if(c("Got input:"+e),null==(n=o(e)))return"ERROR: Unknown or unsupported key signature";var a=F(e);return r=u(e,a)}var i=function(e,a,r,n){this.index=e,this.unNormalizedValue=a,this.normalizedValue=r,this.glyph=n};function o(e){s="Major";var a,r,n=null,l=e.match(/[kK]: *([A-G])([b#])? *(.*?)$/m);if(null==l||l.length<3)return null;a=void 0==l[2]?l[1]:l[1]+l[2];var i=/%.*/;if(r=(r=(r=l[3].toLowerCase()).replace(i,"")).trim(),t=(t=a).replace("#","s"),gNonMoveableSolfege=!1,c("Got base key of '"+a+"' and extra of '"+r+"'"),""==r||-1!=r.search("maj")||-1!=r.search("ion")?(c("Mode: Ionian (major)"),s="Major",n=_(a,0)):-1!=r.search("mix")?(c("Mode: Mixolydian"),s="Major",n=_(a,1)):-1!=r.search("dor")?(c("Mode: Dorian"),s="Minor",n=_(a,2)):-1!=r.search("m")&&-1==r.search("mix")||-1!=r.search("min")||-1!=r.search("aeo")?(c("Mode: Aeolian (minor)"),s="Minor",n=_(a,3)):-1!=r.search("phr")?(c("Mode: Phrygian"),s="Major",n=_(a,4)):-1!=r.search("loc")?(c("Mode: Locrian"),s="Major",n=_(a,5)):-1!=r.search("lyd")?(c("Mode: Lydian"),s="Major",n=_(a,-1)):-1!=r.search("exp")?(c("(Accidentals to be explicitly specified)"),s="Major",n=_("C",0)):(c("Failed to determine key signature mode"),n=null),null==n)return n;var o=r.match(/_./g),u=r.match(/\^./g);for(note in o)n.flats+=o[note][1].toUpperCase();for(note in u)n.sharps+=u[note][1].toUpperCase();return n}function _(e,a){var r="FCGDAEB",n={sharps:"",flats:""},t=r.indexOf(e[0])-1;if(-2==t)return c("Bad tonic: "+e),null;"b"==e.slice(1)?t-=7:"#"==e.slice(1)&&(t+=7);var s=t-a;return s>7?(c("Too many sharps: "+s),null):s<-7?(c("Too many flats: "+-1*s),null):(s>0?n.sharps=r.slice(0,s):s<0&&(n.flats=r.slice(s)),n.accidentalSharps="",n.accidentalFlats="",n.accidentalNaturals="",n)}function u(e,a){for(var r,n=e,t=0,s=0;s<a.length;++s){var c=a[s].index+t;r=a[s].glyph,a[s].normalizedValue;var l=r.length;n=n.substr(0,c)+r+n.substr(c),t+=l}return n}function d(e,a,r){for(var n="",t=0;t<r;++t)n+="*";return e.substr(0,a)+n+e.substr(a+r)}var f={c:0,"^c":1,d:2,"^d":3,e:4,f:5,"^f":6,g:7,"^g":8,a:9,"^a":10,b:11},g={c:0,_d:1,d:2,_e:3,e:4,f:5,_g:6,g:7,_a:8,a:9,_b:10,b:11},h={"^b":0,"=c":0,_d:1,"=d":2,_f:4,"=e":4,"^e":5,"=f":5,_g:6,"=g":7,_a:8,"=a":9,_b:10,"=b":11,_c:11},$={0:"c",1:"^c",2:"d",3:"^d",4:"e",5:"f",6:"^f",7:"g",8:"^g",9:"a",10:"^a",11:"b"},p={0:"c",1:"_d",2:"d",3:"_e",4:"e",5:"f",6:"_g",7:"g",8:"_a",9:"a",10:"_b",11:"b"},m={0:"c",1:"_d",2:"d",3:"_e",4:"e",5:"f",6:"_g",7:"g",8:"_a",9:"a",10:"_b",11:"b"},G={C:0,Cs:1,Db:1,D:2,Ds:3,Eb:3,E:4,F:5,Fs:6,Gb:6,G:7,Gs:8,Ab:8,A:9,As:10,Bb:10,B:11};function v(e,a,r){e=(e=(e=e.toLowerCase()).replaceAll(",","")).replaceAll("'","");var t=!0;""!=n.flats&&(t=!1),(6==gShapeNoteStyle||7==gShapeNoteStyle||8==gShapeNoteStyle)&&(a="C",r="Major");var s=G[a];if(t){var c=f[e],l=!1,i=!1;void 0===c&&(void 0!==(c=g[e])?l=!0:(c=h[e],i=!0)),6!=gShapeNoteStyle&&7!=gShapeNoteStyle&&8!=gShapeNoteStyle&&"Minor"==r&&(c-=3)<0&&(c+=12),(c-=s)<0&&(c+=12),c%=12,e=l?p[c]:i?m[c]:$[c]}else{var c=g[e],l=!1,i=!1;void 0===c&&(void 0!==(c=f[e])?l=!0:(c=h[e],i=!0)),6!=gShapeNoteStyle&&7!=gShapeNoteStyle&&8!=gShapeNoteStyle&&"Minor"==r&&(c-=3)<0&&(c+=12),(c-=s)<0&&(c+=12),c%=12,e=l?$[c]:i?m[c]:p[c]}return e}function A(e){var a,r="";switch(e=v(e,t,s),gShapeNoteStyle){case 0:a={"^b":"!style=sn_fa!",c:"!style=sn_fa!","^c":"!style=sn_fa!",_d:"!style=sn_so!",d:"!style=sn_so!","^d":"!style=sn_so!",_e:"!style=sn_la!",e:"!style=sn_la!",_f:"!style=sn_la!","^e":"!style=sn_fa!",f:"!style=sn_fa!","^f":"!style=sn_fa!",_g:"!style=sn_so!",g:"!style=sn_so!","^g":"!style=sn_so!",_a:"!style=sn_la!",a:"!style=sn_la!","^a":"!style=sn_la!",_b:"!style=sn_mi!",b:"!style=sn_mi!",_c:"!style=sn_mi!"};break;case 1:a={"^b":'"_fa"!style=sn_fa!',c:'"_fa"!style=sn_fa!',"^c":'"_fa"!style=sn_fa!',_d:'"_sol"!style=sn_so!',d:'"_sol"!style=sn_so!',"^d":'"_sol"!style=sn_so!',_e:'"_la"!style=sn_la!',e:'"_la"!style=sn_la!',_f:'"_la"!style=sn_la!',"^e":'"_fa"!style=sn_fa!',f:'"_fa"!style=sn_fa!',"^f":'"_fa"!style=sn_fa!',_g:'"_sol"!style=sn_so!',g:'"_sol"!style=sn_so!',"^g":'"_sol"!style=sn_so!',_a:'"_la"!style=sn_la!',a:'"_la"!style=sn_la!',"^a":'"_la"!style=sn_la!',_b:'"_mi"!style=sn_mi!',b:'"_mi"!style=sn_mi!',_c:'"_mi"!style=sn_mi!'};break;case 2:a={"^b":'"_fa"',c:'"_fa"',"^c":'"_fa"',_d:'"_sol"',d:'"_sol"',"^d":'"_sol"',_e:'"_la"',e:'"_la"',_f:'"_la"',"^e":'"_fa"',f:'"_fa"',"^f":'"_fa"',_g:'"_sol"',g:'"_sol"',"^g":'"_sol"',_a:'"_la"',a:'"_la"',"^a":'"_la"',_b:'"_mi"',b:'"_mi"',_c:'"_mi"'};break;case 3:a={"^b":"!style=sn_do!",c:"!style=sn_do!","^c":"!style=sn_do!",_d:"!style=sn_re!",d:"!style=sn_re!","^d":"!style=sn_re!",_e:"!style=sn_mi!",e:"!style=sn_mi!",_f:"!style=sn_mi!","^e":"!style=sn_fa!",f:"!style=sn_fa!","^f":"!style=sn_fa!",_g:"!style=sn_so!",g:"!style=sn_so!","^g":"!style=sn_so!",_a:"!style=sn_la!",a:"!style=sn_la!","^a":"!style=sn_la!",_b:"!style=sn_ti!",b:"!style=sn_ti!",_c:"!style=sn_ti!"};break;case 4:a={"^b":'"_do"!style=sn_do!',c:'"_do"!style=sn_do!',"^c":'"_do"!style=sn_do!',_d:'"_re"!style=sn_re!',d:'"_re"!style=sn_re!',"^d":'"_re"!style=sn_re!',_e:'"_mi"!style=sn_mi!',e:'"_mi"!style=sn_mi!',_f:'"_mi"!style=sn_mi!',"^e":'"_fa"!style=sn_fa!',f:'"_fa"!style=sn_fa!',"^f":'"_fa"!style=sn_fa!',_g:'"_sol"!style=sn_so!',g:'"_sol"!style=sn_so!',"^g":'"_sol"!style=sn_so!',_a:'"_la"!style=sn_la!',a:'"_la"!style=sn_la!',"^a":'"_la"!style=sn_la!',_b:'"_ti"!style=sn_ti!',b:'"_ti"!style=sn_ti!',_c:'"_ti"!style=sn_ti!'};break;case 5:a={"^b":'"_do"',c:'"_do"',"^c":'"_do"',_d:'"_re"',d:'"_re"',"^d":'"_re"',_e:'"_mi"',e:'"_mi"',_f:'"_mi"',"^e":'"_fa"',f:'"_fa"',"^f":'"_fa"',_g:'"_sol"',g:'"_sol"',"^g":'"_sol"',_a:'"_la"',a:'"_la"',"^a":'"_la"',_b:'"_ti"',b:'"_ti"',_c:'"_ti"'};break;case 6:var a={"^b":'"_C"',c:'"_C"',"^c":'"_C#"',_d:'"_D♭"',d:'"_D"',"^d":'"_D#"',_e:'"_E♭"',e:'"_E"',_f:'"_E"',"^e":'"_F"',f:'"_F"',"^f":'"_F#"',_g:'"_G♭"',g:'"_G"',"^g":'"_G#"',_a:'"_A♭"',a:'"_A"',"^a":'"_A#"',_b:'"_B♭"',b:'"_B"',_c:'"_B"'};break;case 7:var a={"^b":'"_do"',c:'"_do"',"^c":'"_do"',_d:'"_re"',d:'"_re"',"^d":'"_re"',_e:'"_mi"',e:'"_mi"',_f:'"_mi"',"^e":'"_fa"',f:'"_fa"',"^f":'"_fa"',_g:'"_sol"',g:'"_sol"',"^g":'"_sol"',_a:'"_la"',a:'"_la"',"^a":'"_la"',_b:'"_ti"',b:'"_ti"',_c:'"_ti"'};break;case 8:case 9:case 10:var a={"^b":'"_do"',c:'"_do"',"^c":'"_di"',_d:'"_ra"',d:'"_re"',"^d":'"_ri"',_e:'"_me"',e:'"_mi"',_f:'"_mi"',"^e":'"_fa"',f:'"_fa"',"^f":'"_fi"',_g:'"_se"',g:'"_sol"',"^g":'"_si"',_a:'"_le"',a:'"_la"',"^a":'"_li"',_b:'"_te"',b:'"_ti"',_c:'"_ti"'}}return(r=a[e])?r:"x "}function F(e){for(var a,r,t=e,s=/^\w:.*$/mg;a=s.exec(e);)t=d(t,a.index,a[0].length);for(var l=/"[^"]*"/gm;r=l.exec(t);)for(var o=r.index,_=o+r[0].length,u=o;u<_;++u)t=t.substring(0,u)+"*"+t.substring(u+1);for(l=/\[[^\]|]*\]/g;r=l.exec(t);)for(var o=r.index,_=o+r[0].length,u=o;u<_;++u)t=t.substring(0,u)+"*"+t.substring(u+1);for(l=/![^!\n]*!/gm;r=l.exec(t);)for(var o=r.index,_=o+r[0].length,u=o;u<_;++u)t=t.substring(0,u)+"*"+t.substring(u+1);for(l=/^%%begintext((.|\n)*)%%endtext/gm;r=l.exec(t);)for(var o=r.index,_=o+r[0].length,u=o;u<_;++u)t=t.substring(0,u)+"*"+t.substring(u+1);for(l=/^%.*$/gm;r=l.exec(t);)for(var o=r.index,_=o+r[0].length,u=o;u<_;++u)t=t.substring(0,u)+"*"+t.substring(u+1);c("sanitized input:"+(t=t.replaceAll("!","*")));for(var f=/([=^_]?[a-gA-G][',]?|\|)/g,g=[];r=f.exec(t);){var h=r[1];if("|"==h)n.accidentalFlats="",n.accidentalSharps="",n.accidentalNaturals="";else{var $=x(h);c("UnNormalized="+h+" normalized="+$);var p=A($);g.push(new i(r.index,h,$,p))}}return g}function x(e){var a=e.search(/[A-G]/i);if(-1==a)return c("Failed to find basename for value!"),e;var r=e.substr(a,1).toUpperCase();return"="==e.substr(0,1)?(n.accidentalFlats=n.accidentalFlats.replace(r,""),n.accidentalSharps=n.accidentalSharps.replace(r,""),n.accidentalNaturals+=r,e.substr(1)):"_"==e.substr(0,1)?(n.accidentalFlats+=r,n.accidentalSharps=n.accidentalSharps.replace(r,""),n.accidentalNaturals=n.accidentalNaturals.replace(r,""),e):"^"==e.substr(0,1)?(n.accidentalFlats=n.accidentalFlats.replace(r,""),n.accidentalNaturals=n.accidentalNaturals.replace(r,""),n.accidentalSharps+=r,e):-1!=n.accidentalNaturals.search(r)?e:-1!=n.sharps.search(r)||-1!=n.accidentalSharps.search(r)?"^"+e:-1!=n.flats.search(r)||-1!=n.accidentalFlats.search(r)?"_"+e:e}function D(e){return e.split(/^X:.*$/gm).length-1}function E(e,a){return"X:"+e.split(/^X:/gm)[a+1]}function C(e){var a=gInjectTab_FontFamily,r=gInjectTab_TabFontSize,c=gInjectTab_StaffSep;n=null,t=null,s="Major";for(var i=D(e),o=FindPreTuneHeader(e),_=0;_<i;++_){var u=E(e,_);if(isSectionHeader(u)){o+="\n",o+=u,o+="\n";continue}switch(u=l(u),u=InjectStringBelowTuneHeaderConditional(u,"%%staffsep "+c),gShapeNoteStyle){case 1:case 2:case 4:case 5:case 6:case 7:case 8:case 9:case 10:u=InjectStringAboveTuneHeaderConditional(u,"%%annotationfont "+a+" "+r)}o+=u,o+="\n"}return o.replaceAll("\n\n","\n")}return C(e)},injectABCNoteNames=function(e){var a=!1,r=null;function n(e){a&&console.log(e)}function t(e){if(n("Got input:"+e),null==(r=c(e)))return"ERROR: Unknown or unsupported key signature";var a=u(e);return i(e,a)}var s=function(e,a,r,n){this.index=e,this.unNormalizedValue=a,this.normalizedValue=r,this.glyph=n};function c(e){var a,r,t=null,s=e.match(/^K: *([A-G])([b#])? *(.*?)$/m);if(null==s||s.length<3)return null;a=void 0==s[2]?s[1]:s[1]+s[2];var c=/%.*/;if(n("Got base key of '"+a+"' and extra of '"+(r=(r=(r=s[3].toLowerCase()).replace(c,"")).trim())+"'"),""==r||-1!=r.search("maj")||-1!=r.search("ion")?(n("Mode: Ionian (major)"),t=l(a,0)):-1!=r.search("mix")?(n("Mode: Mixolydian"),t=l(a,1)):-1!=r.search("dor")?(n("Mode: Dorian"),t=l(a,2)):-1!=r.search("m")&&-1==r.search("mix")||-1!=r.search("min")||-1!=r.search("aeo")?(n("Mode: Aeolian (minor)"),t=l(a,3)):-1!=r.search("phr")?(n("Mode: Phrygian"),t=l(a,4)):-1!=r.search("loc")?(n("Mode: Locrian"),t=l(a,5)):-1!=r.search("lyd")?(n("Mode: Lydian"),t=l(a,-1)):-1!=r.search("exp")?(n("(Accidentals to be explicitly specified)"),t=l("C",0)):(n("Failed to determine key signature mode"),t=null),null==t)return t;var i=r.match(/_./g),o=r.match(/\^./g);for(note in i)t.flats+=i[note][1].toUpperCase();for(note in o)t.sharps+=o[note][1].toUpperCase();return t}function l(e,a){var r="FCGDAEB",t={sharps:"",flats:""},s=r.indexOf(e[0])-1;if(-2==s)return n("Bad tonic: "+e),null;"b"==e.slice(1)?s-=7:"#"==e.slice(1)&&(s+=7);var c=s-a;return c>7?(n("Too many sharps: "+c),null):c<-7?(n("Too many flats: "+-1*c),null):(c>0?t.sharps=r.slice(0,c):c<0&&(t.flats=r.slice(c)),t.accidentalSharps="",t.accidentalFlats="",t.accidentalNaturals="",t)}function i(e,a){for(var r,n=e,t=0,s=0;s<a.length;++s){var c=a[s].index+t,l=a[s].glyph;l.length;var i=(r='"_'+l+'"').length;n=n.substr(0,c)+r+n.substr(c),t+=i}return n}function o(e,a,r){for(var n="",t=0;t<r;++t)n+="*";return e.substr(0,a)+n+e.substr(a+r)}function _(e){if(11==gShapeNoteStyle){var a={"D,":"D,","^D,":"D#,","_E,":"E♭,","E,":"E,","^E,":"E#,","_F,":"F♭,","F,":"F,","^F,":"F#,","_G,":"G♭,","G,":"G,","^G,":"G#,","_A,":"A♭,","A,":"A,","^A,":"A#,","_B,":"B♭,","B,":"B,","^B,":"B#,",_C:"C♭",C:"C","^C":"C#",_D:"D♭",D:"D","^D":"D#",_E:"E♭",E:"E","^E":"E#",_F:"F♭",F:"F","^F":"F#",_G:"G♭",G:"G","^G":"G#",_A:"A♭",A:"A","^A":"A#",_B:"B♭",B:"B","^B":"B#",_c:"c♭",c:"c","^c":"c#",_d:"d♭",d:"d","^d":"d#",_e:"e♭",e:"e","^e":"e#",_f:"f♭",f:"f","^f":"f#",_g:"g♭",g:"g","^g":"g#",_a:"a♭",a:"a","^a":"a#",_b:"b♭",b:"b","^b":"b#","_c'":"c♭'","c'":"c'","^c'":"c#'","_d'":"d♭'","d'":"d'","^d'":"d#'","_e'":"e♭'","e'":"e'","^e'":"e#'","_F'":"F♭'","f'":"f'","^f'":"f#'","_g'":"g♭'","g'":"g'","=D,":"D,","=E,":"E,","=F,":"F,","=G,":"G,","=A,":"A,","=B,":"B,","=C":"C,","=D":"D","=E":"E","=F":"F","=G":"G","=A":"A","=B":"B","=c":"c","=d":"d","=e":"e","=f":"f","=g":"g","=a":"a","=b":"b","=c'":"c'","=d'":"d'","=e'":"e'","=f'":"f'","=g'":"g'","C'":"c","^C'":"c#","_D'":"d♭","D'":"d","^D'":"d#","_E'":"e♭","E'":"e","F'":"f","^F'":"f#","_G'":"g♭","G'":"g","^G'":"g#","_A'":"a♭","A'":"a","^A'":"a#","_B'":"b♭","B'":"b","C''":"c'","^C''":"c#'","_D''":"d♭'","D''":"d'","^D''":"d#'","_E''":"e♭'","E''":"e'","F''":"f'","^F''":"f#'","_G''":"g♭'","G''":"g'","=C'":"c","=D'":"d","=E'":"e","=F'":"f","=G'":"g","=A'":"a","=B'":"b","=C''":"c'","=D''":"d'","=E''":"e'","=F''":"f'","=G''":"g'"},r=a[e];return r||(r="x "),r}var a={"D,":"D,","^D,":"D#,","_E,":"E♭,","E,":"E,","^E,":"E#,","_F,":"F♭,","F,":"F,","^F,":"F#,","_G,":"G♭,","G,":"G,","^G,":"G#,","_A,":"A♭,","A,":"A,","^A,":"A#,","_B,":"B♭,","B,":"B,","^B,":"B#,",_C:"C♭,",C:"C,","^C":"C,#",_D:"D♭",D:"D","^D":"D#",_E:"E♭",E:"E","^E":"E#",_F:"F♭",F:"F","^F":"F#",_G:"G♭",G:"G","^G":"G#",_A:"A♭",A:"A","^A":"A#",_B:"B♭",B:"B","^B":"B#",_c:"C♭",c:"C","^c":"C#",_d:"D♭'",d:"D'","^d":"D#'",_e:"E♭'",e:"E'","^e":"E#'",_f:"F♭'",f:"F'","^f":"F#'",_g:"G♭'",g:"G'","^g":"G#'",_a:"A♭'",a:"A'","^a":"A#'",_b:"B♭'",b:"B'","^b":"B#'","_c'":"C♭'","c'":"C'","^c'":"C#'","_d'":"D♭''","d'":"D''","^d'":"D#''","_e'":"E♭''","e'":"E''","^e'":"E#''","_f'":"F♭''","f'":"F''","^f'":"F#''","_g'":"G♭''","g'":"G''","=D,":"D,","=E,":"E,","=F,":"F,","=G,":"G,","=A,":"A,","=B,":"B,","=C":"C,","=D":"D","=E":"E","=F":"F","=G":"G","=A":"A","=B":"B","=c":"C","=d":"D'","=e":"E'","=f":"F'","=g":"G'","=a":"A'","=b":"B'","=c'":"C'","=d'":"D''","=e'":"E''","=f'":"F''","=g'":"G''","C'":"C","^C'":"C#","_D'":"D♭'","D'":"D'","^D'":"D#'","_E'":"E♭'","E'":"E'","F'":"F'","^F'":"F#'","_G'":"G♭'","G'":"G'","^G'":"G#'","_A'":"A♭'","A'":"A'","^A'":"A#'","_B'":"B♭'","B'":"B'","C''":"C'","^C''":"C#'","_D''":"D♭''","D''":"D''","^D''":"D#''","_E''":"E♭''","E''":"E''","F''":"F''","^F''":"F#''","_G''":"G♭''","G''":"G''","=C'":"C","=D'":"D'","=E'":"E'","=F'":"F'","=G'":"G'","=A'":"A'","=B'":"B'","=C''":"C'","=D''":"D''","=E''":"E''","=F''":"F''","=G''":"G''"},r=a[e];return r||(r="x "),r}function u(e){for(var a,t,c=e,l=/^\w:.*$/mg;a=l.exec(e);)c=o(c,a.index,a[0].length);for(var i=/"[^"]*"/gm;t=i.exec(c);)for(var u=t.index,f=u+t[0].length,g=u;g<f;++g)c=c.substring(0,g)+"*"+c.substring(g+1);for(i=/\[[^\]|]*\]/g;t=i.exec(c);)for(var u=t.index,f=u+t[0].length,g=u;g<f;++g)c=c.substring(0,g)+"*"+c.substring(g+1);for(i=/![^!\n]*!/gm;t=i.exec(c);)for(var u=t.index,f=u+t[0].length,g=u;g<f;++g)c=c.substring(0,g)+"*"+c.substring(g+1);for(i=/^%%begintext((.|\n)*)%%endtext/gm;t=i.exec(c);)for(var u=t.index,f=u+t[0].length,g=u;g<f;++g)c=c.substring(0,g)+"*"+c.substring(g+1);for(i=/^%.*$/gm;t=i.exec(c);)for(var u=t.index,f=u+t[0].length,g=u;g<f;++g)c=c.substring(0,g)+"*"+c.substring(g+1);n("sanitized input:"+(c=c.replaceAll("!","*")));for(var h=/([=^_]?[a-gA-G][',]?|\|)/g,$=[];t=h.exec(c);){var p=t[1];if("|"==p)r.accidentalFlats="",r.accidentalSharps="",r.accidentalNaturals="";else{var m=d(p);n("UnNormalized="+p+" normalized="+m);var G=_(m);$.push(new s(t.index,p,m,G))}}return $}function d(e){var a=e.search(/[A-G]/i);if(-1==a)return n("Failed to find basename for value!"),e;var t=e.substr(a,1).toUpperCase();return"="==e.substr(0,1)?(r.accidentalFlats=r.accidentalFlats.replace(t,""),r.accidentalSharps=r.accidentalSharps.replace(t,""),r.accidentalNaturals+=t,e.substr(1)):"_"==e.substr(0,1)?(r.accidentalFlats+=t,r.accidentalSharps=r.accidentalSharps.replace(t,""),r.accidentalNaturals=r.accidentalNaturals.replace(t,""),e):"^"==e.substr(0,1)?(r.accidentalFlats=r.accidentalFlats.replace(t,""),r.accidentalNaturals=r.accidentalNaturals.replace(t,""),r.accidentalSharps+=t,e):-1!=r.accidentalNaturals.search(t)?e:-1!=r.sharps.search(t)||-1!=r.accidentalSharps.search(t)?"^"+e:-1!=r.flats.search(t)||-1!=r.accidentalFlats.search(t)?"_"+e:e}function f(e){return e.split(/^X:.*$/gm).length-1}function g(e,a){return"X:"+e.split(/^X:/gm)[a+1]}function h(e){for(var a=gInjectTab_FontFamily,r=gInjectTab_TabFontSize,n=gInjectTab_StaffSep,s=f(e),c=FindPreTuneHeader(e),l=0;l<s;++l){var i=g(e,l);if(isSectionHeader(i)){c+="\n",c+=i,c+="\n";continue}i=t(i),i=InjectStringBelowTuneHeaderConditional(i,"%%staffsep "+n),i=InjectStringAboveTuneHeaderConditional(i,"%%annotationfont "+a+" "+r),c+=i,c+="\n"}return c.replaceAll("\n\n","\n")}return h(e)},HarmonicaTabGenerator=function(theABC){var abcOutput="";function generate_harmonica_tab(tuneABC,harpKey,octaveShift,blowPlus){function getNote(n){n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=n.replace(/\/.*/,"")).replace(/^([A-G])#/,"^$1")).replace(/^([A-G])b/,"_$1")).replace(/C/g,"+13")).replace(/D/g,"+15")).replace(/E/g,"+17")).replace(/F/g,"+18")).replace(/G/g,"+20")).replace(/A/g,"+22")).replace(/B/g,"+24")).replace(/c/g,"+25")).replace(/d/g,"+27")).replace(/e/g,"+29")).replace(/f/g,"+30")).replace(/g/g,"+32")).replace(/a/g,"+34")).replace(/b/g,"+36")).replace(/\^/g,"+1")).replace(/_/g,"-1")).replace(/,/g,"-12")).replace(/'/g,"+12");try{n=eval(n)}catch(error){n=0}return n}function getNoteName(e){let a;for(;e>12;)e-=12;switch(e){case 1:a="C";break;case 2:a="C#/Db";break;case 3:a="D";break;case 4:a="D#/Eb";break;case 5:a="E";break;case 6:a="F";break;case 7:a="F#/Gb";break;case 8:a="G";break;case 9:a="G#/Ab";break;case 10:a="A";break;case 11:a="A#/Bb";break;case 12:a="B";break;default:a=""}return a}function min2maj(e){let a;return/m/.test(e)?(a=getNote(e=e.replace(/m(inor)?/,"")),(a+=3)>24&&(a-=12)):a=getNote(e),a}function getTrueNote(e,a){let r,n;return/=/.test(e)?r=getNote(e=e.replace(/=/g,"")):0==(r=getNote(e))?1:/__/.test(e)||/\^\^/.test(e)||13===(n=min2maj(a))?r:([6,18,30].includes(r)&&r++,20===n)?r:([1,13,25,37].includes(r)&&r++,15===n)?r:([8,20,32].includes(r)&&r++,22===n)?r:([3,15,27].includes(r)&&r++,17===n)?r:([10,22,34].includes(r)&&r++,24===n)?r:([5,17,29].includes(r)&&r++,19===n)?r:([12,24,36].includes(r)&&r++,14===n)?r:(r=getNote(e),n=min2maj(a),[12,24,36].includes(r)&&r--,18===n)?r:([5,17,29].includes(r)&&r--,23===n)?r:([10,22,34].includes(r)&&r--,16===n)?r:([3,15,27].includes(r)&&r--,21===n)?r:([8,20,32].includes(r)&&r--,14===n)?r:([1,13,25,37].includes(r)&&r--,19===n)?r:([6,18,30].includes(r)&&r--,24===n)?r:(console.log("There was an error recognising the notes. The tab will probably be wrong."),0)}let transposeHarp=0;function setHarpKey(e){transposeHarp=(transposeHarp=getNote(e)-12)>=8&&transposeHarp<=12?13-transposeHarp:1-transposeHarp}var tab=[];switch(tab[0]="x",gHarmonicaStyle){case"0":default:blowPlus?(tab[1]="+1",tab[2]="–1'",tab[3]="–1",tab[4]="+1o",tab[5]="+2",tab[6]="–2''",tab[7]="–2'",tab[8]="+3",tab[9]="–3'''",tab[10]="–3''",tab[11]="–3'",tab[12]="–3",tab[13]="+4",tab[14]="–4'",tab[15]="–4",tab[16]="+4o",tab[17]="+5",tab[18]="–5",tab[19]="+5o",tab[20]="+6",tab[21]="–6'",tab[22]="–6",tab[23]="+6o",tab[24]="–7",tab[25]="+7",tab[26]="–7o",tab[27]="–8",tab[28]="+8'",tab[29]="+8",tab[30]="–9",tab[31]="+9'",tab[32]="+9",tab[33]="–9o",tab[34]="–10",tab[35]="+10''",tab[36]="+10'",tab[37]="+10",tab[38]="–10o'"):(tab[1]="1",tab[2]="–1'",tab[3]="–1",tab[4]="1o",tab[5]="2",tab[6]="–2''",tab[7]="–2'",tab[8]="3",tab[9]="–3'''",tab[10]="–3''",tab[11]="–3'",tab[12]="–3",tab[13]="4",tab[14]="–4'",tab[15]="–4",tab[16]="4o",tab[17]="5",tab[18]="–5",tab[19]="5o",tab[20]="6",tab[21]="–6'",tab[22]="–6",tab[23]="6o",tab[24]="–7",tab[25]="7",tab[26]="–7o",tab[27]="–8",tab[28]="8'",tab[29]="8",tab[30]="–9",tab[31]="9'",tab[32]="9",tab[33]="–9o",tab[34]="–10",tab[35]="10''",tab[36]="10'",tab[37]="10",tab[38]="–10o'");break;case"1":blowPlus?(tab[1]="+1",tab[2]="–1'",tab[3]="–1",tab[4]="+1o",tab[5]="+2",tab[6]="–2''",tab[7]="–2'",tab[8]="–2",tab[9]="–3'''",tab[10]="+3",tab[11]="–3'",tab[12]="–3",tab[13]="+4",tab[14]="–4'",tab[15]="–4",tab[16]="+4o",tab[17]="+5",tab[18]="–5",tab[19]="+5o",tab[20]="+6",tab[21]="–6'",tab[22]="–6",tab[23]="+6o",tab[24]="–7",tab[25]="+7",tab[26]="–7o",tab[27]="–8",tab[28]="+8'",tab[29]="+8",tab[30]="–9",tab[31]="+9'",tab[32]="+9",tab[33]="–9o",tab[34]="–10",tab[35]="+10''",tab[36]="+10'",tab[37]="+10",tab[38]="–10o'"):(tab[1]="1",tab[2]="–1'",tab[3]="–1",tab[4]="1o",tab[5]="2",tab[6]="–2''",tab[7]="–2'",tab[8]="–2",tab[9]="–3'''",tab[10]="3",tab[11]="–3'",tab[12]="–3",tab[13]="4",tab[14]="–4'",tab[15]="–4",tab[16]="4o",tab[17]="5",tab[18]="–5",tab[19]="5o",tab[20]="6",tab[21]="–6'",tab[22]="–6",tab[23]="6o",tab[24]="–7",tab[25]="7",tab[26]="–7o",tab[27]="–8",tab[28]="8'",tab[29]="8",tab[30]="–9",tab[31]="9'",tab[32]="9",tab[33]="–9o",tab[34]="–10",tab[35]="10''",tab[36]="10'",tab[37]="10",tab[38]="–10o'")}let keySig="C",octaveAdjust=0,verbose=!1,lineCount=0,abcHeaderDone=!1;setHarpKey(harpKey),"-1"==octaveShift?octaveAdjust=-12:"1"==octaveShift&&(octaveAdjust=12);var theOutput="",theLines=tuneABC.split("\n");for(let line of theLines)if(lineCount++,/^\w:/.test(line)||/^%/.test(line)||"\n"===line){if(theOutput+=line+"\n",(match=line.match(/^T:\s*(.*)$/))&&verbose&&console.log(`Title: ${match[1]}`),match=line.match(/^K:\s*(.*)$/)){switch(abcHeaderDone=!0,(keySig=(keySig=(keySig=(keySig=(keySig=(keySig=(keySig=(keySig=(keySig=match[1]).replaceAll(" ","")).replace(/\s?(treble[+-]?\d?|bass\d?|alto\d?|none|perc)/,"")).replace(/\s?major/,"")).replace(/\s?Major/,"")).replace(/\s?maj/,"")).replace(/\s?Maj/,"")).replace(/^([A-G])#/,"^$1")).replace(/^([A-G])b/,"_$1")).toLowerCase()){case"ddor":case"ddorian":case"amin":case"aminor":case"amin":case"aminor":case"ddor":case"ddorian":case"gmix":case"gmixolydian":keySig="C";break;case"edor":case"edorian":case"bmin":case"bminor":case"amix":case"amixolydian":keySig="D";break;case"ador":case"adorian":case"emin":case"eminor":case"dmix":case"dmixolydian":keySig="G";break;case"bdor":case"bdorian":keySig="A";break;case"gdor":case"gdorian":case"dmin":case"dminor":keySig="F"}verbose&&console.log(`Key signature: ${keySig}`),"0"==gHarmonicaStyle?0==octaveAdjust?theOutput+="%%text "+harpKey+" Harp (Standard Richter)\n":-12==octaveAdjust?theOutput+="%%text "+harpKey+" Harp / -1 Octave (Standard Richter)\n":12==octaveAdjust&&(theOutput+="%%text "+harpKey+" Harp / +1 Octave (Standard Richter)\n"):0==octaveAdjust?theOutput+="%%text "+harpKey+" Harp (Paddy Richter)\n":-12==octaveAdjust?theOutput+="%%text "+harpKey+" Harp / -1 Octave (Paddy Richter)\n":12==octaveAdjust&&(theOutput+="%%text "+harpKey+" Harp / +1 Octave (Paddy Richter)\n"),theOutput+="%%vskip 15\n"}}else{if(""==line)break;theOutput+=line+"\n";let harpLine=line,notes=(harpLine=(harpLine=(harpLine=(harpLine=(harpLine=(harpLine=(harpLine=(harpLine=(harpLine=(harpLine=(harpLine=(harpLine=(harpLine=(harpLine=(harpLine=(harpLine=(harpLine=harpLine.replace(/\[\w:.*?\]/g,"")).replace(/%.*?$/,"")).replace(/\\/g,"")).replace(/"(.*?)"/g,"")).replace(/[<>\.~]/g,"")).replace(/!.*?!/g,"")).replace(/{.*?}/g,"")).replace(/\(([^()]*)\)/g,"$1")).replace(/\[([\^_=]*?[A-Ga-gzx][\,']*).*?\]/g,"$1")).replace(/\(\d/g,"")).replace(/\|\d/g,"")).replace(/[\|\]:]/g,"")).replace(/([\^_=]*?[A-Ga-gzx][\,']*)\d?\/?\*?/g,"$1 ")).replace(/-\s*[\^_=]*?[A-Ga-gzx][\,']*/g,"*")).replace(/-/g,"")).replace(/[zx]\d?/g,"")).replace(/\s+/g," ")).trim().split(" ");var outNotes=[];for(let j=0;j<notes.length;j++){let note=notes[j];if("*"!==note){let abcNote=note,noteIndex=getTrueNote(abcNote,keySig)+octaveAdjust+transposeHarp;noteIndex<0&&(noteIndex=0),noteIndex>38&&(noteIndex=0),note=tab[noteIndex],verbose&&console.log("abcNote: "+abcNote+" noteIndex: "+noteIndex+" note: "+note),verbose&&"x"===note&&console.log(`Line ${lineCount}: Warning: ${abcNote} is not playable on the ${harpKey} harp`),outNotes.push(note)}}"w:"!==(harpLine=(harpLine=(harpLine="w: "+outNotes.join(" ").trim()).replace(/\s+/g," ")).trim())&&(theOutput+=`${harpLine}
`)}return theOutput+"\n"}function countTunes(e){return e.split(/^X:.*$/gm).length-1}function getTuneByIndex(e,a){return"X:"+e.split(/^X:/gm)[a+1]}function stripHarmonicaTab(e){return e.split("\n").filter(e=>!/^w:|^%%vskip 15$|^%%vocalfont|^%%text\s\w{1,2}\sHarp/.test(e)).join("\n")}function generateTablature(e){for(var a=gInjectTab_FontFamily,r=gInjectTab_TabFontSize,n=gInjectTab_StaffSep,t=countTunes(e),s=FindPreTuneHeader(e),c=0;c<t;++c){var l=getTuneByIndex(e,c);if(isSectionHeader(l)){s+="\n",s+=l,s+="\n";continue}l=stripHarmonicaTab(l),l=generate_harmonica_tab(l,gHarmonicaKey,gHarmonicaOctave,gHarmonicaPlusSign),l=InjectStringBelowTuneHeaderConditional(l,"%%staffsep "+n),l=InjectStringAboveTuneHeaderConditional(l,"%%vocalfont "+a+" "+r),s+=l,s+="\n"}return s.replaceAll("\n\n","\n")}return generateTablature(theABC)};